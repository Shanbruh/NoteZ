<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NoteZ">
<meta name="theme-color" content="#7c6dfa" id="theme-color-meta">
<title>NoteZ</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKK7lSt7_S9zhibXEkpAl75gBUWxKcwmA",
    authDomain: "notez-e2e36.firebaseapp.com",
    databaseURL: "https://notez-e2e36-default-rtdb.firebaseio.com",
    projectId: "notez-e2e36",
    storageBucket: "notez-e2e36.firebasestorage.app",
    messagingSenderId: "40028336367",
    appId: "1:40028336367:web:fb1dd35125899ef0d1ab1a"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const auth = getAuth(app);

  // Expose to global scope for non-module functions
  window._firebaseDB = database;
  window._firebaseAuth = auth;
  window._firebaseRef = ref;
  window._firebaseSet = set;
  window._firebaseGet = get;
  window._firebaseUpdate = update;
  window._firebaseRemove = remove;
  window._firebaseSignIn = signInWithEmailAndPassword;
  window._firebaseCreateUser = createUserWithEmailAndPassword;
  window._firebaseSignOut = signOut;
  window._firebaseOnAuthStateChanged = onAuthStateChanged;
  window._firebaseUpdateProfile = updateProfile;

  // Auth state listener
  onAuthStateChanged(auth, (user) => {
    if (user) {
      window._currentFirebaseUser = user;
      window._onFirebaseLogin && window._onFirebaseLogin(user);
    } else {
      window._currentFirebaseUser = null;
      window._onFirebaseLogout && window._onFirebaseLogout();
    }
  });
</script>
<style>
  :root {
    --bg: #0f0f11;
    --bg2: #16161a;
    --bg3: #1e1e24;
    --bg4: #26262e;
    --border: #2e2e38;
    --text: #e8e8f0;
    --text2: #9090a8;
    --text3: #5a5a72;
    --accent: #7c6dfa;
    --accent2: #a594ff;
    --accent-glow: rgba(124,109,250,0.18);
    --danger: #ff5b6b;
    --success: #3ddc97;
    --warn: #f4a24b;
    --sidebar-w: 260px;
    --radius: 10px;
    --font: 'Syne', sans-serif;
    --mono: 'DM Mono', monospace;
    --transition: 0.18s cubic-bezier(.4,0,.2,1);
  }
  [data-theme="light"] {
    --bg: #f5f4f8;
    --bg2: #ffffff;
    --bg3: #eeedf3;
    --bg4: #e4e3ea;
    --border: #d4d3e0;
    --text: #18181f;
    --text2: #55546a;
    --text3: #9998b0;
    --accent: #6b5ce7;
    --accent2: #8878ff;
    --accent-glow: rgba(107,92,231,0.12);
  }
  [data-theme="navy"] {
    --bg: #0a0f1e;
    --bg2: #0e1529;
    --bg3: #131d38;
    --bg4: #1a2648;
    --border: #1f3060;
    --text: #d0dcff;
    --text2: #7a92cc;
    --text3: #3a5090;
    --accent: #4d9fff;
    --accent2: #74b8ff;
    --accent-glow: rgba(77,159,255,0.15);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; overflow: hidden; background: var(--accent); }

  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    transition: background var(--transition), color var(--transition);
    position: relative;
    height: 100%;
    /* Safe area for notched phones */
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }

  /* DUOTONE ICONS */
  .dt-icon { width: 18px; height: 18px; display: block; }
  .dt-bg { fill: var(--text3); opacity: 0.25; }
  .dt-stroke { stroke: var(--text2); }
  .dt-stroke-only { stroke: var(--text2); }
  .sb-nav-btn.active .dt-bg { fill: var(--accent); opacity: 0.3; }
  .sb-nav-btn.active .dt-stroke { stroke: var(--accent2); }
  .sb-nav-btn.active .dt-stroke-only { stroke: var(--accent2); }
  .sb-nav-btn:hover .dt-bg { fill: var(--text2); opacity: 0.2; }
  .sb-nav-btn:hover .dt-stroke { stroke: var(--text); }

  /* LAYOUT */
  #app { display: flex; height: 100vh; position: relative; z-index: 1; }

  /* LOGIN */
  #login-screen {
    position: fixed; inset: 0; z-index: 100;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column;
  }
  #login-screen .login-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 48px 44px;
    width: 100%; max-width: 400px;
    text-align: center;
    box-shadow: 0 8px 60px rgba(0,0,0,0.35);
  }
  .login-logo {
    font-size: 2.6rem;
    font-weight: 800;
    letter-spacing: -1px;
    margin-bottom: 6px;
  }
  .login-logo span { color: var(--accent); }
  .login-sub { color: var(--text2); font-size: 0.9rem; margin-bottom: 32px; }
  .login-card input {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    color: var(--text);
    font-family: var(--font);
    font-size: 0.95rem;
    margin-bottom: 12px;
    outline: none;
    transition: border var(--transition), box-shadow var(--transition);
  }
  .login-card input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
  .login-card .btn-primary {
    width: 100%; margin-top: 6px;
    padding: 13px;
    border-radius: 8px;
    font-size: 1rem; font-weight: 700;
  }
  .login-tabs { display: flex; gap: 0; margin-bottom: 28px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
  .login-tab { flex: 1; padding: 10px; cursor: pointer; background: transparent; border: none; color: var(--text2); font-family: var(--font); font-size: 0.9rem; transition: all var(--transition); }
  .login-tab.active { background: var(--accent); color: #fff; font-weight: 600; }
  .login-err { color: var(--danger); font-size: 0.83rem; margin-top: 8px; min-height: 18px; }

  /* SIDEBAR */
  .sidebar {
    width: var(--sidebar-w);
    min-width: var(--sidebar-w);
    background: var(--bg2);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
    transition: transform var(--transition), width var(--transition), min-width var(--transition);
    position: relative;
    z-index: 10;
  }
  .sidebar.collapsed { transform: translateX(-100%); position: absolute; }

  .sidebar-logo {
    padding: 22px 20px 14px;
    font-size: 1.5rem;
    font-weight: 800;
    letter-spacing: -0.5px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 8px;
  }
  .sidebar-logo span.z { color: var(--accent); }
  .sidebar-logo .logo-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 8px var(--accent); }

  .sidebar-section { padding: 10px 12px 4px; font-size: 0.7rem; font-weight: 700; letter-spacing: 1.2px; color: var(--text3); text-transform: uppercase; }

  .sidebar-btn {
    display: flex; align-items: center; gap: 9px;
    padding: 8px 14px;
    margin: 1px 8px;
    border-radius: 7px;
    cursor: pointer;
    font-size: 0.88rem;
    font-weight: 500;
    color: var(--text2);
    transition: all var(--transition);
    border: none; background: transparent; width: calc(100% - 16px);
    text-align: left;
  }
  .sidebar-btn:hover, .sidebar-btn.active { background: var(--bg3); color: var(--text); }
  .sidebar-btn .icon { font-size: 1rem; width: 18px; text-align: center; flex-shrink: 0; }

  .sidebar-scroll { flex: 1; overflow-y: auto; padding-bottom: 10px; }
  .sidebar-scroll::-webkit-scrollbar { width: 4px; }
  .sidebar-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* Folder tree */
  .folder-item { }
  .folder-header {
    display: flex; align-items: center; gap: 7px;
    padding: 7px 10px 7px 14px;
    margin: 1px 8px;
    border-radius: 7px;
    cursor: pointer;
    font-size: 0.88rem; font-weight: 500;
    color: var(--text2);
    transition: all var(--transition);
    user-select: none;
  }
  .folder-header:hover { background: var(--bg3); color: var(--text); }
  .folder-header.active { background: var(--accent-glow); color: var(--accent2); }
  .folder-arrow { font-size: 0.65rem; transition: transform var(--transition); flex-shrink: 0; }
  .folder-arrow.open { transform: rotate(90deg); }
  .folder-children { display: none; padding-left: 14px; }
  .folder-children.open { display: block; }
  .folder-note-item {
    padding: 6px 10px 6px 12px;
    margin: 1px 8px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.83rem;
    color: var(--text3);
    transition: all var(--transition);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    display: flex; align-items: center; gap: 6px;
  }
  .folder-note-item:hover { background: var(--bg3); color: var(--text2); }
  .folder-note-item.active { color: var(--accent2); background: var(--accent-glow); }

  /* MAIN */
  .main { flex: 1; display: flex; flex-direction: column; min-width: 0; overflow: hidden; }

  /* TOPBAR */
  .topbar {
    height: 54px;
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
    padding: 0 16px;
    flex-shrink: 0;
    z-index: 5;
  }
  .topbar-btn {
    width: 34px; height: 34px; border-radius: 7px;
    display: flex; align-items: center; justify-content: center;
    background: transparent; border: none; cursor: pointer;
    color: var(--text2); font-size: 1.05rem;
    transition: all var(--transition);
    flex-shrink: 0;
  }
  .topbar-btn:hover { background: var(--bg3); color: var(--text); }
  .topbar-title { font-weight: 700; font-size: 1rem; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .topbar-actions { display: flex; align-items: center; gap: 6px; }

  /* VIEW TOGGLE */
  .view-toggle { display: flex; background: var(--bg3); border-radius: 7px; padding: 2px; gap: 1px; }
  .view-btn { width: 28px; height: 28px; border-radius: 5px; border: none; background: transparent; color: var(--text2); cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; transition: all var(--transition); }
  .view-btn.active { background: var(--bg2); color: var(--accent); box-shadow: 0 1px 4px rgba(0,0,0,0.2); }

  /* CONTENT AREA */
  .content-area {
    flex: 1; overflow-y: auto; padding: 24px 28px;
    position: relative;
  }
  .content-area::-webkit-scrollbar { width: 5px; }
  .content-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* PAGE HEADER */
  .page-header { margin-bottom: 24px; }
  .page-title { font-size: 1.7rem; font-weight: 800; letter-spacing: -0.5px; }
  .page-meta { color: var(--text3); font-size: 0.82rem; margin-top: 5px; font-family: var(--mono); }

  /* TAG FILTER */
  .tag-filter-bar { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 20px; align-items: center; }
  .tag-chip {
    padding: 4px 12px; border-radius: 20px;
    font-size: 0.78rem; font-weight: 600;
    cursor: pointer; border: 1px solid var(--border);
    background: var(--bg3); color: var(--text2);
    transition: all var(--transition);
  }
  .tag-chip:hover { border-color: var(--accent); color: var(--accent); }
  .tag-chip.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .tag-chip.all { border-style: dashed; }

  /* NOTES GRID */
  .notes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 14px;
  }
  .notes-list { display: flex; flex-direction: column; gap: 8px; }

  .note-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    cursor: pointer;
    transition: all var(--transition);
    position: relative;
    overflow: hidden;
  }
  .note-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: var(--accent);
    transform: scaleX(0); transform-origin: left;
    transition: transform var(--transition);
  }
  .note-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 28px rgba(0,0,0,0.18); }
  .note-card:hover::before { transform: scaleX(1); }
  .note-card-icon { font-size: 1.6rem; margin-bottom: 10px; }
  .note-card-name { font-weight: 700; font-size: 0.95rem; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .note-card-meta { display: flex; flex-wrap: wrap; gap: 5px; }
  .note-tag { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; background: var(--accent-glow); color: var(--accent2); }
  .note-folder-path { font-size: 0.72rem; color: var(--text3); font-family: var(--mono); margin-top: 4px; }
  .note-card-actions { display: flex; gap: 5px; margin-top: 12px; opacity: 0; transition: opacity var(--transition); }
  .note-card:hover .note-card-actions { opacity: 1; }
  .note-act-btn {
    flex: 1; padding: 5px 8px; border-radius: 6px; border: 1px solid var(--border);
    background: var(--bg3); color: var(--text2); font-size: 0.75rem; font-family: var(--font);
    cursor: pointer; transition: all var(--transition); font-weight: 600;
  }
  .note-act-btn:hover { background: var(--bg4); color: var(--text); }
  .note-act-btn.danger:hover { background: rgba(255,91,107,0.15); color: var(--danger); border-color: var(--danger); }

  /* LIST VIEW */
  .note-list-item {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    cursor: pointer;
    display: flex; align-items: center; gap: 12px;
    transition: all var(--transition);
  }
  .note-list-item:hover { border-color: var(--accent); background: var(--bg3); }
  .note-list-icon { font-size: 1.2rem; flex-shrink: 0; }
  .note-list-name { font-weight: 600; font-size: 0.92rem; flex: 1; }
  .note-list-tags { display: flex; gap: 5px; flex-wrap: wrap; }
  .note-list-path { font-size: 0.75rem; color: var(--text3); font-family: var(--mono); }
  .note-list-actions { display: flex; gap: 5px; opacity: 0; transition: opacity var(--transition); }
  .note-list-item:hover .note-list-actions { opacity: 1; }

  /* BUTTONS */
  .btn-primary {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-family: var(--font);
    font-weight: 700;
    font-size: 0.88rem;
    cursor: pointer;
    transition: all var(--transition);
    display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-primary:hover { opacity: 0.88; transform: translateY(-1px); }
  .btn-secondary {
    background: var(--bg3);
    color: var(--text2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    font-family: var(--font);
    font-weight: 600;
    font-size: 0.88rem;
    cursor: pointer;
    transition: all var(--transition);
  }
  .btn-secondary:hover { background: var(--bg4); color: var(--text); }

  /* UPLOAD DROP ZONE */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 32px 24px;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition);
    margin-bottom: 24px;
    background: var(--bg2);
  }
  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--accent);
    background: var(--accent-glow);
  }
  .upload-zone .upload-icon { font-size: 2rem; margin-bottom: 10px; }
  .upload-zone p { color: var(--text2); font-size: 0.88rem; }
  .upload-zone strong { color: var(--accent); }

  /* NOTE VIEWER OVERLAY */
  #note-viewer {
    display: none;
    position: fixed; inset: 0; z-index: 50;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
  }
  #note-viewer.open { display: flex; }
  .note-window {
    position: absolute;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 14px;
    box-shadow: 0 20px 80px rgba(0,0,0,0.5);
    display: flex; flex-direction: column;
    overflow: hidden;
    min-width: 320px; min-height: 200px;
  }
  .note-window-titlebar {
    height: 42px;
    background: var(--bg3);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 8px;
    padding: 0 12px;
    cursor: grab; user-select: none;
    flex-shrink: 0;
  }
  .note-window-titlebar:active { cursor: grabbing; }
  .win-title { flex: 1; font-size: 0.88rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .win-btn { width: 26px; height: 26px; border-radius: 50%; border: none; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; transition: all var(--transition); flex-shrink: 0; }
  .win-btn.close { background: var(--danger); color: #fff; }
  .win-btn.fullscreen { background: var(--success); color: #fff; }
  .win-btn.close:hover, .win-btn.fullscreen:hover { opacity: 0.8; transform: scale(1.1); }
  .note-window-body { flex: 1; overflow: hidden; position: relative; }
  .note-window-body iframe { width: 100%; height: 100%; border: none; background: #fff; }
  .resize-handle {
    position: absolute; bottom: 0; right: 0;
    width: 18px; height: 18px;
    cursor: se-resize;
    display: flex; align-items: flex-end; justify-content: flex-end;
    padding: 3px;
    color: var(--text3);
    font-size: 0.7rem;
    z-index: 2;
  }
  .note-window.fullscreen-win {
    inset: 0 !important;
    width: 100% !important;
    height: 100% !important;
    border-radius: 0;
    top: 0 !important;
    left: 0 !important;
    transform: none !important;
  }
  .note-window.fullscreen-win .resize-handle { display: none; }
  .note-window.fullscreen-win .note-window-titlebar { display: none; }
  .note-window.fullscreen-win .note-window-body { height: 100%; }

  /* MODAL */
  .modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 60;
    background: rgba(0,0,0,0.55); backdrop-filter: blur(4px);
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 28px 28px 24px;
    width: 90%; max-width: 420px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  }
  .modal h3 { font-size: 1.15rem; font-weight: 800; margin-bottom: 16px; }
  .modal input, .modal select {
    width: 100%; background: var(--bg3); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 12px; color: var(--text);
    font-family: var(--font); font-size: 0.9rem; margin-bottom: 10px; outline: none;
    transition: border var(--transition);
  }
  .modal input:focus, .modal select:focus { border-color: var(--accent); }
  .modal-actions { display: flex; gap: 8px; margin-top: 6px; justify-content: flex-end; }
  .modal label { font-size: 0.8rem; color: var(--text2); display: block; margin-bottom: 4px; font-weight: 600; letter-spacing: 0.3px; }

  /* TAGS INPUT */
  .tags-input-wrap { display: flex; flex-wrap: wrap; gap: 5px; background: var(--bg3); border: 1px solid var(--border); border-radius: 8px; padding: 7px; margin-bottom: 10px; cursor: text; }
  .tags-input-wrap:focus-within { border-color: var(--accent); }
  .tag-pill { background: var(--accent); color: #fff; border-radius: 20px; padding: 2px 8px 2px 10px; font-size: 0.77rem; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
  .tag-pill-remove { cursor: pointer; opacity: 0.7; font-size: 0.8rem; }
  .tag-pill-remove:hover { opacity: 1; }
  .tags-input-wrap input { border: none; background: transparent; outline: none; font-family: var(--font); color: var(--text); font-size: 0.88rem; flex: 1; min-width: 80px; }

  /* SETTINGS / WALLPAPER PANEL */
  .settings-panel {
    display: none; flex-direction: column; gap: 12px; padding: 24px 28px;
    overflow-y: auto; flex: 1;
  }
  .settings-panel.open { display: flex; }
  .settings-section-title { font-size: 0.7rem; font-weight: 700; letter-spacing: 1.2px; text-transform: uppercase; color: var(--text3); margin-bottom: 4px; margin-top: 8px; }
  .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .theme-opt {
    border-radius: 9px; padding: 12px 8px; text-align: center; cursor: pointer;
    border: 2px solid transparent; font-size: 0.8rem; font-weight: 700;
    transition: all var(--transition);
  }
  .theme-opt:hover { transform: scale(1.03); }
  .theme-opt.active { border-color: var(--accent); }
  .theme-opt.dark { background: #0f0f11; color: #e8e8f0; }
  .theme-opt.light { background: #f5f4f8; color: #18181f; }
  .theme-opt.navy { background: #0a0f1e; color: #d0dcff; }
  .accent-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
  .accent-opt {
    height: 36px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;
    transition: all var(--transition);
  }
  .accent-opt:hover { transform: scale(1.05); }
  .accent-opt.active { border-color: var(--text); }
  .wallpaper-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .wp-opt {
    height: 60px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;
    transition: all var(--transition); overflow: hidden; position: relative;
    background-size: cover; background-position: center;
  }
  .wp-opt:hover { border-color: var(--accent); }
  .wp-opt.active { border-color: var(--accent); }
  .wp-none { display: flex; align-items: center; justify-content: center; background: var(--bg3); font-size: 0.8rem; color: var(--text2); font-weight: 600; }
  .wp-custom-btn { grid-column: span 3; }

  /* EMPTY STATE */
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text3); }
  .empty-state .empty-icon { font-size: 3rem; margin-bottom: 14px; }
  .empty-state p { font-size: 0.9rem; }

  /* FOLDER FORM */
  .new-folder-btn {
    display: flex; align-items: center; gap: 7px;
    padding: 7px 14px; margin: 2px 8px;
    border-radius: 7px; cursor: pointer;
    font-size: 0.82rem; font-weight: 600; color: var(--accent2);
    border: 1px dashed var(--border); background: transparent;
    width: calc(100% - 16px); transition: all var(--transition);
  }
  .new-folder-btn:hover { border-color: var(--accent); background: var(--accent-glow); }

  /* TOAST */
  #toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: var(--bg3); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 18px; font-size: 0.88rem; font-weight: 600;
    z-index: 200; transition: transform 0.3s ease; pointer-events: none;
    white-space: nowrap;
  }
  #toast.show { transform: translateX(-50%) translateY(0); }
  @media (max-width: 700px) {
    #toast { bottom: 68px; }
  }

  /* SIDEBAR BOTTOM NAV */
  .sidebar-bottom-nav {
    display: flex; align-items: center; gap: 2px;
    padding: 8px 10px;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
    background: var(--bg2);
  }
  .sb-nav-btn {
    width: 36px; height: 36px; border-radius: 8px;
    border: none; background: transparent;
    cursor: pointer; font-size: 1.1rem;
    display: flex; align-items: center; justify-content: center;
    color: var(--text2);
    transition: all var(--transition);
    flex-shrink: 0;
  }
  .sb-nav-btn:hover { background: var(--bg3); color: var(--text); }
  .sb-nav-btn.active { background: var(--accent-glow); color: var(--accent2); }
  .user-avatar {
    width: 32px; height: 32px; border-radius: 50%;
    background: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 0.85rem; color: #fff;
    flex-shrink: 0;
  }

  /* SEARCH TAG INDICATOR */
  .active-tag-indicator {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 12px;
    background: var(--accent-glow);
    border-radius: 8px;
    font-size: 0.84rem;
    color: var(--accent2);
    margin-bottom: 16px;
  }
  .clear-tag { cursor: pointer; font-size: 0.9rem; margin-left: auto; }

  /* MOBILE */
  @media (max-width: 700px) {
    .sidebar {
      position: fixed; left: 0; top: 0; bottom: 0;
      z-index: 20;
      transform: translateX(-100%);
      transition: transform 0.25s cubic-bezier(.4,0,.2,1);
    }
    .sidebar.mobile-open { transform: translateX(0); }
    .mobile-overlay {
      display: none; position: fixed; inset: 0; z-index: 15;
      background: rgba(0,0,0,0.4);
    }
    .mobile-overlay.open { display: block; }
    .notes-grid { grid-template-columns: 1fr 1fr; }
    .content-area { padding: 16px; }
    .note-window { width: 92vw !important; height: 75vh !important; left: 4vw !important; top: 10vh !important; }

    /* Mobile bottom tab bar */
    .mobile-bottom-nav {
      display: flex !important;
    }
    .topbar { display: none; }
    .main { padding-bottom: 60px; }
    .sidebar-bottom-nav { display: none !important; }
  }

  /* Mobile bottom nav bar */
  .mobile-bottom-nav {
    display: none;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 56px;
    background: var(--bg2);
    border-top: 1px solid var(--border);
    z-index: 30;
    align-items: center;
    justify-content: space-around;
    padding-bottom: env(safe-area-inset-bottom);
    flex-shrink: 0;
  }
  .mob-nav-btn {
    flex: 1; height: 100%;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: transparent; border: none; cursor: pointer;
    color: var(--text2); font-size: 0.62rem; font-weight: 600;
    gap: 3px; transition: all var(--transition);
    padding: 0;
  }
  .mob-nav-btn svg { flex-shrink: 0; }
  .mob-nav-btn.active { color: var(--accent); }
  .mob-nav-btn.active .dt-bg { fill: var(--accent); opacity: 0.3; }
  .mob-nav-btn.active .dt-stroke { stroke: var(--accent); }
  .mob-nav-btn.active .dt-stroke-only { stroke: var(--accent); }
  .mob-nav-btn:hover { color: var(--text); }

  @media (max-width: 420px) {
    .notes-grid { grid-template-columns: 1fr; }
  }

  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* LOADING OVERLAY */
  #app-loading {
    position: fixed; inset: 0; z-index: 999;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 16px;
  }
  #app-loading .spin {
    width: 36px; height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #app-loading .load-logo { font-size: 1.8rem; font-weight: 800; }
  #app-loading .load-logo span { color: var(--accent); }

  .page-hidden { display: none !important; }
</style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="app-loading">
  <div class="load-logo">Note<span>Z</span></div>
  <div class="spin"></div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">Note<span class="z">Z</span></div>
    <div class="login-sub">Your personal HTML notes workspace</div>
    <div class="login-tabs">
      <button class="login-tab active" id="tab-login" onclick="switchLoginTab('login')">Sign In</button>
      <button class="login-tab" id="tab-signup" onclick="switchLoginTab('signup')">Sign Up</button>
    </div>
    <div id="login-form">
      <input type="text" id="login-username" placeholder="Username or Email" autocomplete="username">
      <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
      <button class="btn-primary" style="width:100%;margin-top:6px;padding:13px" onclick="doLogin()">Sign In →</button>
      <div class="login-err" id="login-err"></div>
    </div>
    <div id="signup-form" style="display:none">
      <input type="text" id="signup-username" placeholder="Choose a username" autocomplete="username">
      <input type="email" id="signup-email" placeholder="Email (optional)">
      <input type="password" id="signup-password" placeholder="Password">
      <input type="password" id="signup-confirm" placeholder="Confirm password">
      <button class="btn-primary" style="width:100%;margin-top:6px;padding:13px" onclick="doSignup()">Create Account →</button>
      <div class="login-err" id="signup-err"></div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none">
  <!-- Mobile overlay -->
  <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileSidebar()"></div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <span class="logo-dot"></span>
      Note<span class="z">Z</span>
    </div>
    <div class="sidebar-scroll">
      <div style="height:8px"></div>
      <div class="sidebar-section">Folders</div>
      <div id="folder-tree"></div>
      <button class="new-folder-btn" onclick="openNewFolderModal()">
        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        New Folder
      </button>
    </div>

    <!-- BOTTOM NAV -->
    <div class="sidebar-bottom-nav">
      <div class="user-avatar" id="user-avatar-text" title="Signed in" style="cursor:default">U</div>
      <!-- Home -->
      <button class="sb-nav-btn active" id="nav-home" onclick="navigate('home')" title="All Notes">
        <svg viewBox="0 0 24 24" class="dt-icon"><path class="dt-bg" d="M3 10.5L12 3l9 7.5V20a1 1 0 01-1 1H4a1 1 0 01-1-1V10.5z"/><path class="dt-stroke" d="M3 10.5L12 3l9 7.5" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path class="dt-stroke" d="M9 21v-6h6v6" fill="none" stroke-width="1.8" stroke-linecap="round"/></svg>
      </button>
      <!-- Upload -->
      <button class="sb-nav-btn" id="nav-upload" onclick="navigate('upload')" title="Upload">
        <svg viewBox="0 0 24 24" class="dt-icon"><rect class="dt-bg" x="3" y="15" width="18" height="6" rx="1"/><path class="dt-stroke" d="M12 3v12M7 8l5-5 5 5" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <!-- Settings -->
      <button class="sb-nav-btn" id="nav-settings" onclick="navigate('settings')" title="Settings">
        <svg viewBox="0 0 24 24" class="dt-icon"><circle class="dt-bg" cx="12" cy="12" r="9"/><circle class="dt-stroke-only" cx="12" cy="12" r="3" fill="none" stroke-width="1.8"/><path class="dt-stroke" d="M12 5v2M12 17v2M5 12H3M21 12h-2M7.05 7.05L5.64 5.64M18.36 18.36l-1.41-1.41M7.05 16.95l-1.41 1.41M18.36 5.64l-1.41 1.41" fill="none" stroke-width="1.8" stroke-linecap="round"/></svg>
      </button>
      <!-- Logout -->
      <button class="sb-nav-btn" onclick="doLogout()" title="Sign out" style="margin-left:auto">
        <svg viewBox="0 0 24 24" class="dt-icon"><rect class="dt-bg" x="3" y="3" width="10" height="18" rx="1"/><path class="dt-stroke" d="M15 8l4 4-4 4M9 12h10" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- TOPBAR -->
    <div class="topbar">
      <button class="topbar-btn" id="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="topbar-title" id="topbar-title">All Notes</div>
      <div class="topbar-actions">
        <div class="view-toggle" id="view-toggle">
          <!-- Grid -->
          <button class="view-btn active" id="view-grid" onclick="setView('grid')" title="Grid">
            <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          </button>
          <!-- List -->
          <button class="view-btn" id="view-list" onclick="setView('list')" title="List">
            <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="3.5" cy="6" r="1" fill="currentColor"/><circle cx="3.5" cy="12" r="1" fill="currentColor"/><circle cx="3.5" cy="18" r="1" fill="currentColor"/></svg>
          </button>
          <!-- Tree -->
          <button class="view-btn" id="view-tree" onclick="setView('tree')" title="Folder Tree">
            <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h7v4H3zM14 4h7v4h-7zM14 16h7v4h-7z"/><path d="M6 8v4M6 12h8M17.5 12v4"/></svg>
          </button>
        </div>
        <button class="btn-primary" onclick="navigate('upload')" style="padding:7px 13px;font-size:0.82rem">+ Upload</button>
      </div>
    </div>

    <!-- HOME PAGE -->
    <div id="page-home" class="content-area">
      <div class="page-header">
        <div class="page-title">All Notes</div>
        <div class="page-meta" id="notes-count-meta">0 notes</div>
      </div>
      <div id="tag-filter-bar" class="tag-filter-bar"></div>
      <div id="active-tag-indicator" class="active-tag-indicator" style="display:none">
        <span>Filtering by: <strong id="active-tag-label"></strong></span>
        <span class="clear-tag" onclick="clearTagFilter()">✕</span>
      </div>
      <div id="notes-container"></div>
      <div id="empty-state" class="empty-state" style="display:none">
        <div class="empty-icon">
          <svg viewBox="0 0 64 64" width="52" height="52"><path d="M8 20h48v36a2 2 0 01-2 2H10a2 2 0 01-2-2V20z" fill="var(--accent)" opacity="0.12"/><path d="M8 20l8-12h16l4 6h20a2 2 0 012 2" fill="none" stroke="var(--text3)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M24 40h16M24 48h10" fill="none" stroke="var(--text3)" stroke-width="2" stroke-linecap="round"/></svg>
        </div>
        <p>No notes yet. Upload some HTML files to get started!</p>
      </div>
    </div>

    <!-- UPLOAD PAGE -->
    <div id="page-upload" class="content-area page-hidden">
      <div class="page-header">
        <div class="page-title">Upload Note</div>
        <div class="page-meta">Drop HTML files to add them to NoteZ</div>
      </div>
      <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
        <div class="upload-icon">
          <svg viewBox="0 0 48 48" width="44" height="44">
            <rect x="6" y="28" width="36" height="14" rx="3" fill="var(--accent)" opacity="0.18"/>
            <path d="M24 6v26M14 16l10-10 10 10" fill="none" stroke="var(--accent2)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <p><strong>Click or drag & drop</strong> HTML files here</p>
        <p style="margin-top:6px;font-size:0.8rem;color:var(--text3)">Only .html files are accepted</p>
      </div>
      <input type="file" id="file-input" accept=".html,.htm" multiple style="display:none" onchange="handleFiles(this.files)">

      <div id="upload-form" style="display:none">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px 22px;margin-bottom:14px">
          <div id="upload-file-name" style="font-weight:700;font-size:1rem;margin-bottom:16px"></div>

          <label>Note Name</label>
          <input type="text" id="upload-name" placeholder="Name your note">

          <label>Folder</label>
          <select id="upload-folder">
            <option value="">— No folder —</option>
          </select>

          <label>Tags (press Enter to add)</label>
          <div class="tags-input-wrap" id="upload-tags-wrap" onclick="document.getElementById('upload-tag-input').focus()">
            <input type="text" id="upload-tag-input" placeholder="Type a tag…" onkeydown="handleTagInput(event)">
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn-primary" onclick="saveNote()">Save Note</button>
            <button class="btn-secondary" onclick="cancelUpload()">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SETTINGS PAGE -->
    <div id="page-settings" class="content-area page-hidden">
      <div class="page-header">
        <div class="page-title">Settings</div>
      </div>

      <div class="settings-section-title">Theme</div>
      <div class="theme-grid">
        <div class="theme-opt dark active" data-theme="dark" onclick="setTheme('dark')">Dark</div>
        <div class="theme-opt light" data-theme="light" onclick="setTheme('light')">Light</div>
        <div class="theme-opt navy" data-theme="navy" onclick="setTheme('navy')">Navy</div>
      </div>

      <div class="settings-section-title" style="margin-top:20px">Accent Color</div>
      <div class="accent-grid">
        <div class="accent-opt active" data-accent="purple" style="background:linear-gradient(135deg,#7c6dfa,#a594ff)" onclick="setAccent('purple','#7c6dfa','#a594ff','rgba(124,109,250,0.18)')"></div>
        <div class="accent-opt" data-accent="blue" style="background:linear-gradient(135deg,#3b82f6,#60a5fa)" onclick="setAccent('blue','#3b82f6','#60a5fa','rgba(59,130,246,0.15)')"></div>
        <div class="accent-opt" data-accent="green" style="background:linear-gradient(135deg,#10b981,#34d399)" onclick="setAccent('green','#10b981','#34d399','rgba(16,185,129,0.15)')"></div>
        <div class="accent-opt" data-accent="orange" style="background:linear-gradient(135deg,#f59e0b,#fbbf24)" onclick="setAccent('orange','#f59e0b','#fbbf24','rgba(245,158,11,0.15)')"></div>
      </div>
    </div>
  </div>
</div>

<!-- NOTE VIEWER OVERLAY -->
<div id="note-viewer">
  <div class="note-window" id="note-window" style="width:780px;height:560px;left:50%;top:50%;transform:translate(-50%,-50%)">
    <div class="note-window-titlebar" id="note-win-titlebar">
      <span class="win-title" id="note-win-title">Note</span>
      <button class="win-btn fullscreen" onclick="toggleFullscreenWin()" title="Fullscreen">
        <svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M8 3H5a2 2 0 00-2 2v3M16 3h3a2 2 0 012 2v3M21 16v3a2 2 0 01-2 2h-3M8 21H5a2 2 0 01-2-2v-3"/></svg>
      </button>
      <button class="win-btn close" onclick="closeNoteViewer()" title="Close">
        <svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="note-window-body">
      <iframe id="note-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>
    <div class="resize-handle" id="resize-handle">
      <svg viewBox="0 0 10 10" width="10" height="10" fill="none" stroke="var(--text3)" stroke-width="1.2" stroke-linecap="round"><line x1="9" y1="1" x2="1" y2="9"/><line x1="9" y1="5" x2="5" y2="9"/></svg>
    </div>
  </div>
</div>

<!-- MOBILE BOTTOM NAV -->
<div class="mobile-bottom-nav" id="mobile-bottom-nav">
  <button class="mob-nav-btn active" id="mob-nav-home" onclick="navigate('home')" title="All Notes">
    <svg viewBox="0 0 24 24" class="dt-icon" width="22" height="22"><path class="dt-bg" d="M3 10.5L12 3l9 7.5V20a1 1 0 01-1 1H4a1 1 0 01-1-1V10.5z"/><path class="dt-stroke" d="M3 10.5L12 3l9 7.5" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path class="dt-stroke" d="M9 21v-6h6v6" fill="none" stroke-width="1.8" stroke-linecap="round"/></svg>
    <span>Home</span>
  </button>
  <button class="mob-nav-btn" id="mob-nav-upload" onclick="navigate('upload')" title="Upload">
    <svg viewBox="0 0 24 24" class="dt-icon" width="22" height="22"><rect class="dt-bg" x="3" y="15" width="18" height="6" rx="1"/><path class="dt-stroke" d="M12 3v12M7 8l5-5 5 5" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <span>Upload</span>
  </button>
  <button class="mob-nav-btn" id="mob-nav-settings" onclick="navigate('settings')" title="Settings">
    <svg viewBox="0 0 24 24" class="dt-icon" width="22" height="22"><circle class="dt-bg" cx="12" cy="12" r="9"/><circle class="dt-stroke-only" cx="12" cy="12" r="3" fill="none" stroke-width="1.8"/><path class="dt-stroke" d="M12 5v2M12 17v2M5 12H3M21 12h-2M7.05 7.05L5.64 5.64M18.36 18.36l-1.41-1.41M7.05 16.95l-1.41 1.41M18.36 5.64l-1.41 1.41" fill="none" stroke-width="1.8" stroke-linecap="round"/></svg>
    <span>Settings</span>
  </button>
  <button class="mob-nav-btn" onclick="doLogout()" title="Sign out">
    <svg viewBox="0 0 24 24" class="dt-icon" width="22" height="22"><rect class="dt-bg" x="3" y="3" width="10" height="18" rx="1"/><path class="dt-stroke" d="M15 8l4 4-4 4M9 12h10" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <span>Logout</span>
  </button>
</div>
<!-- New Folder Modal -->
<div class="modal-overlay" id="folder-modal">
  <div class="modal">
    <h3>New Folder</h3>
    <label>Folder Name</label>
    <input type="text" id="folder-name-input" placeholder="e.g. Projects">
    <label>Parent Folder (optional)</label>
    <select id="folder-parent-select"><option value="">— Root —</option></select>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeFolderModal()">Cancel</button>
      <button class="btn-primary" onclick="createFolder()">Create</button>
    </div>
  </div>
</div>

<!-- Rename Modal -->
<div class="modal-overlay" id="rename-modal">
  <div class="modal">
    <h3>Rename Note</h3>
    <label>New Name</label>
    <input type="text" id="rename-input" placeholder="New name">
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeRenameModal()">Cancel</button>
      <button class="btn-primary" onclick="confirmRename()">Rename</button>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal-overlay" id="delete-modal">
  <div class="modal">
    <h3>Delete Note</h3>
    <p style="color:var(--text2);font-size:0.9rem;margin-bottom:16px">Are you sure you want to delete <strong id="delete-note-name"></strong>? This cannot be undone.</p>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn-primary" style="background:var(--danger)" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE & STORAGE
// ============================================================
let currentUser = null;
let notes = [];
let folders = [];
let settings = { theme: 'dark', accent: 'purple' };
let currentView = 'grid';
let activeTag = null;
let currentPage = 'home';
let uploadTags = [];
let pendingFile = null;
let renameTarget = null;
let deleteTarget = null;

// Firebase helpers
function getDB() { return window._firebaseDB; }
function userRef(path) { return window._firebaseRef(getDB(), `users/${currentUser}/${path}`); }

async function loadUserDataFromFirebase() {
  const snap = await window._firebaseGet(userRef('data'));
  const data = snap.val() || { notes: [], folders: [], settings: { theme:'dark', accent:'purple' } };
  notes = data.notes || [];
  folders = data.folders || [];
  settings = data.settings || { theme:'dark', accent:'purple' };
}

async function saveUserData() {
  await window._firebaseSet(userRef('data'), { notes, folders, settings });
}

// ============================================================
// LOGIN / AUTH (Firebase)
// ============================================================
function switchLoginTab(tab) {
  document.getElementById('tab-login').classList.toggle('active', tab==='login');
  document.getElementById('tab-signup').classList.toggle('active', tab==='signup');
  document.getElementById('login-form').style.display = tab==='login' ? '' : 'none';
  document.getElementById('signup-form').style.display = tab==='signup' ? '' : 'none';
}

async function doLogin() {
  const email = document.getElementById('login-username').value.trim();
  const p = document.getElementById('login-password').value;
  const err = document.getElementById('login-err');
  if (!email || !p) { err.textContent = 'Please fill in all fields.'; return; }
  // Support username or email
  const loginEmail = email.includes('@') ? email : email + '@notez.app';
  try {
    const cred = await window._firebaseSignIn(window._firebaseAuth, loginEmail, p);
    // loginSuccess will be called by onAuthStateChanged
  } catch(e) {
    err.textContent = e.code === 'auth/invalid-credential' ? 'Invalid username or password.' : e.message;
  }
}

async function doSignup() {
  const u = document.getElementById('signup-username').value.trim();
  const emailInput = document.getElementById('signup-email').value.trim();
  const p = document.getElementById('signup-password').value;
  const c = document.getElementById('signup-confirm').value;
  const err = document.getElementById('signup-err');
  if (!u || !p) { err.textContent = 'Username and password are required.'; return; }
  if (p !== c) { err.textContent = 'Passwords do not match.'; return; }
  if (p.length < 6) { err.textContent = 'Password must be at least 6 characters.'; return; }
  // Use email if provided, else fabricate one from username
  const loginEmail = emailInput || (u + '@notez.app');
  try {
    const cred = await window._firebaseCreateUser(window._firebaseAuth, loginEmail, p);
    await window._firebaseUpdateProfile(cred.user, { displayName: u });
    // loginSuccess will be called by onAuthStateChanged
  } catch(e) {
    err.textContent = e.code === 'auth/email-already-in-use' ? 'Username already taken.' : e.message;
  }
}

async function loginSuccess(firebaseUser) {
  currentUser = firebaseUser.uid;
  const displayName = firebaseUser.displayName || firebaseUser.email.split('@')[0];
  await loadUserDataFromFirebase();
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  document.getElementById('user-avatar-text').textContent = displayName[0].toUpperCase();
  document.getElementById('user-avatar-text').title = displayName;
  applySettings();
  renderAll();
}

async function doLogout() {
  await window._firebaseSignOut(window._firebaseAuth);
  currentUser = null;
  notes = []; folders = []; settings = { theme:'dark', accent:'purple' };
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
}

function getUserData() { return { notes, folders, settings }; }

// Auto-login via Firebase auth state
window._onFirebaseLogin = async (user) => {
  await loginSuccess(user);
  document.getElementById('app-loading').style.display = 'none';
};
window._onFirebaseLogout = () => {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  document.getElementById('app-loading').style.display = 'none';
};

window.addEventListener('DOMContentLoaded', () => {
  // Enter key on login
  document.getElementById('login-password').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
  document.getElementById('login-username').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

  setupDragResize();
  setupUploadZone();
});

// ============================================================
// SETTINGS / THEMES
// ============================================================
const ACCENTS = {
  purple: ['#7c6dfa','#a594ff','rgba(124,109,250,0.18)'],
  blue: ['#3b82f6','#60a5fa','rgba(59,130,246,0.15)'],
  green: ['#10b981','#34d399','rgba(16,185,129,0.15)'],
  orange: ['#f59e0b','#fbbf24','rgba(245,158,11,0.15)'],
};
const WALLPAPERS = {};

function applySettings() {
  document.documentElement.setAttribute('data-theme', settings.theme || 'dark');
  const acc = ACCENTS[settings.accent] || ACCENTS.purple;
  document.documentElement.style.setProperty('--accent', acc[0]);
  document.documentElement.style.setProperty('--accent2', acc[1]);
  document.documentElement.style.setProperty('--accent-glow', acc[2]);
  // Update theme-color meta for mobile status bar / safe area color
  const tcm = document.getElementById('theme-color-meta');
  if (tcm) tcm.setAttribute('content', acc[0]);
  document.documentElement.style.setProperty('background', acc[0]);
  document.querySelectorAll('.theme-opt').forEach(el => el.classList.toggle('active', el.dataset.theme===settings.theme));
  document.querySelectorAll('.accent-opt').forEach(el => el.classList.toggle('active', el.dataset.accent===settings.accent));
}

function setTheme(t) {
  settings.theme = t;
  saveSettings();
  applySettings();
}
function setAccent(name) {
  settings.accent = name;
  saveSettings();
  applySettings();
}
async function saveSettings() {
  if (!currentUser) return;
  getUserData().settings = settings;
  await saveUserData();
}

// ============================================================
// NAVIGATION
// ============================================================
function navigate(page) {
  currentPage = page;
  ['home','upload','settings'].forEach(p => {
    document.getElementById('page-'+p).classList.toggle('page-hidden', p!==page);
    const nb = document.getElementById('nav-'+p);
    if (nb) nb.classList.toggle('active', p===page);
    const mob = document.getElementById('mob-nav-'+p);
    if (mob) mob.classList.toggle('active', p===page);
  });
  const titles = { home:'All Notes', upload:'Upload Note', settings:'Settings' };
  document.getElementById('topbar-title').textContent = titles[page] || '';
  document.getElementById('view-toggle').style.display = page==='home' ? '' : 'none';
  // Mobile: close sidebar
  if (window.innerWidth <= 700) closeMobileSidebar();
}


// ============================================================
// SIDEBAR
// ============================================================
let sidebarCollapsed = false;
function toggleSidebar() {
  if (window.innerWidth <= 700) {
    document.getElementById('sidebar').classList.toggle('mobile-open');
    document.getElementById('mobile-overlay').classList.toggle('open');
  } else {
    sidebarCollapsed = !sidebarCollapsed;
    document.getElementById('sidebar').classList.toggle('collapsed', sidebarCollapsed);
  }
}
function closeMobileSidebar() {
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('mobile-overlay').classList.remove('open');
}

// ============================================================
// FOLDERS
// ============================================================
function openNewFolderModal() {
  renderFolderOptions('folder-parent-select', true);
  document.getElementById('folder-name-input').value = '';
  document.getElementById('folder-modal').classList.add('open');
  setTimeout(() => document.getElementById('folder-name-input').focus(), 50);
}
function closeFolderModal() { document.getElementById('folder-modal').classList.remove('open'); }
async function createFolder() {
  const name = document.getElementById('folder-name-input').value.trim();
  if (!name) return;
  const parent = document.getElementById('folder-parent-select').value;
  const id = 'f_' + Date.now();
  folders.push({ id, name, parent: parent || null });
  await saveUserData();
  closeFolderModal();
  renderFolderTree();
  renderFolderOptions('upload-folder');
  showToast('Folder created!');
}

function renderFolderOptions(selectId, withRoot=false) {
  const sel = document.getElementById(selectId);
  if (!sel) return;
  sel.innerHTML = withRoot ? '<option value="">— Root —</option>' : '<option value="">— No folder —</option>';
  function addOpts(parentId, depth) {
    folders.filter(f => f.parent===(parentId||null)).forEach(f => {
      const opt = document.createElement('option');
      opt.value = f.id;
      opt.textContent = '  '.repeat(depth) + (depth>0?'└ ':'') + f.name;
      sel.appendChild(opt);
      addOpts(f.id, depth+1);
    });
  }
  addOpts(null, 0);
}

function renderFolderTree() {
  const container = document.getElementById('folder-tree');
  container.innerHTML = '';

  function buildTree(parentId, targetEl, depth) {
    const children = folders.filter(f => (f.parent || null) === (parentId || null));
    children.forEach(f => {
      const notesInFolder = notes.filter(n => n.folder === f.id);
      const hasSubfolders = folders.some(sf => sf.parent === f.id);
      const hasChildren = notesInFolder.length > 0 || hasSubfolders;
      const indent = depth * 12;

      const div = document.createElement('div');
      div.className = 'folder-item';

      const header = document.createElement('div');
      header.className = 'folder-header';
      header.style.paddingLeft = (14 + indent) + 'px';
      const folderSVG = `<svg viewBox="0 0 24 24" width="15" height="15" style="flex-shrink:0"><path d="M3 8h18v13a1 1 0 01-1 1H4a1 1 0 01-1-1V8z" fill="var(--accent)" opacity="0.18"/><path d="M3 8l3-5h5l2 3h8a1 1 0 011 1" fill="none" stroke="var(--accent2)" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
      const noteSVG = `<svg viewBox="0 0 24 24" width="13" height="13" style="flex-shrink:0;opacity:0.6"><path d="M6 2h9l5 5v15a1 1 0 01-1 1H5a1 1 0 01-1-1V3a1 1 0 011-1z" fill="var(--text3)" opacity="0.5"/><path d="M14 2v6h6" fill="none" stroke="var(--text3)" stroke-width="1.8" stroke-linecap="round"/></svg>`;
      header.innerHTML = `
        <span class="folder-arrow" style="${!hasChildren ? 'opacity:0.2;' : ''}">▶</span>
        ${folderSVG}
        <span>${f.name}</span>
        <span style="margin-left:auto;font-size:0.72rem;color:var(--text3)">${notesInFolder.length}</span>
      `;

      const childrenEl = document.createElement('div');
      childrenEl.className = 'folder-children';
      childrenEl.id = 'fc_' + f.id;

      // Add notes inside this folder
      notesInFolder.forEach(n => {
        const noteEl = document.createElement('div');
        noteEl.className = 'folder-note-item';
        noteEl.id = 'sfn_' + n.id;
        noteEl.style.paddingLeft = (14 + indent + 12) + 'px';
        noteEl.innerHTML = `${noteSVG} ${n.name}`;
        noteEl.onclick = () => { openNote(n.id); if(window.innerWidth<=700) closeMobileSidebar(); };
        childrenEl.appendChild(noteEl);
      });

      // Recursively add subfolders into childrenEl
      buildTree(f.id, childrenEl, depth + 1);

      header.addEventListener('click', () => {
        if (!hasChildren) return;
        const arrow = header.querySelector('.folder-arrow');
        const isOpen = arrow.classList.toggle('open');
        childrenEl.classList.toggle('open', isOpen);
      });

      div.appendChild(header);
      div.appendChild(childrenEl);
      targetEl.appendChild(div);
    });
  }

  buildTree(null, container, 0);
}



// ============================================================
// NOTES RENDERING
// ============================================================
function renderAll() {
  renderFolderTree();
  renderFolderOptions('upload-folder');
  renderNotes();
  updateNotesCountMeta();
}

function getFolderPath(folderId) {
  if (!folderId) return '';
  const parts = [];
  let current = folderId;
  while (current) {
    const f = folders.find(x => x.id === current);
    if (!f) break;
    parts.unshift(f.name);
    current = f.parent;
  }
  return parts.join(' / ');
}

function renderNotes() {
  const container = document.getElementById('notes-container');
  const emptyState = document.getElementById('empty-state');
  let filtered = notes;
  if (activeTag) filtered = notes.filter(n => n.tags && n.tags.includes(activeTag));

  // Tag filter bar
  const allTags = [...new Set(notes.flatMap(n => n.tags||[]))];
  const tagBar = document.getElementById('tag-filter-bar');
  tagBar.innerHTML = '';
  if (allTags.length > 0) {
    const all = document.createElement('div');
    all.className = 'tag-chip all' + (activeTag ? '' : ' active');
    all.textContent = 'All';
    all.onclick = () => clearTagFilter();
    tagBar.appendChild(all);
    allTags.forEach(tag => {
      const chip = document.createElement('div');
      chip.className = 'tag-chip' + (activeTag===tag?' active':'');
      chip.textContent = '#'+tag;
      chip.onclick = () => filterByTag(tag);
      tagBar.appendChild(chip);
    });
  }

  // Active tag indicator
  const ati = document.getElementById('active-tag-indicator');
  ati.style.display = activeTag ? 'flex' : 'none';
  if (activeTag) document.getElementById('active-tag-label').textContent = '#'+activeTag;

  if (filtered.length === 0) {
    container.innerHTML = '';
    emptyState.style.display = '';
    return;
  }
  emptyState.style.display = 'none';

  if (currentView === 'grid') {
    container.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'notes-grid';
    filtered.forEach(n => grid.appendChild(makeNoteCard(n)));
    container.appendChild(grid);
  } else if (currentView === 'list') {
    container.innerHTML = '';
    const list = document.createElement('div');
    list.className = 'notes-list';
    filtered.forEach(n => list.appendChild(makeNoteListItem(n)));
    container.appendChild(list);
  } else if (currentView === 'tree') {
    container.innerHTML = '';
    // Group by folder
    const byFolder = {};
    filtered.forEach(n => {
      const fid = n.folder || '__root__';
      if (!byFolder[fid]) byFolder[fid] = [];
      byFolder[fid].push(n);
    });
    Object.entries(byFolder).forEach(([fid, fNotes]) => {
      const section = document.createElement('div');
      section.style.marginBottom = '18px';
      const title = document.createElement('div');
      title.style.cssText = 'font-weight:700;font-size:0.82rem;letter-spacing:0.8px;text-transform:uppercase;color:var(--text3);margin-bottom:8px;padding:0 2px;';
      title.textContent = fid==='__root__' ? '📂 Root' : '📁 '+getFolderPath(fid);
      section.appendChild(title);
      const list = document.createElement('div');
      list.className = 'notes-list';
      fNotes.forEach(n => list.appendChild(makeNoteListItem(n)));
      section.appendChild(list);
      container.appendChild(section);
    });
  }
}

function makeNoteCard(n) {
  const div = document.createElement('div');
  div.className = 'note-card';
  const tagHtml = (n.tags||[]).map(t=>`<span class="note-tag">#${t}</span>`).join('');
  const folderPath = getFolderPath(n.folder);
  const noteIconSVG = `<svg viewBox="0 0 24 24" width="22" height="22" style="display:block"><path d="M6 2h9l5 5v15a1 1 0 01-1 1H5a1 1 0 01-1-1V3a1 1 0 011-1z" fill="var(--accent)" opacity="0.18"/><path d="M14 2v6h6M8 13h8M8 17h5" fill="none" stroke="var(--accent2)" stroke-width="1.8" stroke-linecap="round"/></svg>`;
  div.innerHTML = `
    <div class="note-card-icon">${noteIconSVG}</div>
    <div class="note-card-name">${n.name}</div>
    <div class="note-card-meta">${tagHtml}</div>
    ${folderPath ? `<div class="note-folder-path">📁 ${folderPath}</div>` : ''}
    <div class="note-card-actions">
      <button class="note-act-btn" onclick="event.stopPropagation();openRenameModal('${n.id}')">Rename</button>
      <button class="note-act-btn" onclick="event.stopPropagation();downloadNote('${n.id}')">Download</button>
      <button class="note-act-btn danger" onclick="event.stopPropagation();openDeleteModal('${n.id}')">Delete</button>
    </div>
  `;
  div.addEventListener('click', () => openNote(n.id));
  return div;
}

function makeNoteListItem(n) {
  const div = document.createElement('div');
  div.className = 'note-list-item';
  const tagHtml = (n.tags||[]).map(t=>`<span class="note-tag">#${t}</span>`).join('');
  const folderPath = getFolderPath(n.folder);
  div.innerHTML = `
    <div class="note-list-icon"><svg viewBox="0 0 24 24" width="20" height="20"><path d="M6 2h9l5 5v15a1 1 0 01-1 1H5a1 1 0 01-1-1V3a1 1 0 011-1z" fill="var(--accent)" opacity="0.18"/><path d="M14 2v6h6M8 13h8M8 17h5" fill="none" stroke="var(--accent2)" stroke-width="1.8" stroke-linecap="round"/></svg></div>
    <div>
      <div class="note-list-name">${n.name}</div>
      ${folderPath ? `<div class="note-list-path">📁 ${folderPath}</div>` : ''}
      <div class="note-list-tags" style="margin-top:4px">${tagHtml}</div>
    </div>
    <div class="note-list-actions">
      <button class="note-act-btn" style="padding:5px 8px" onclick="event.stopPropagation();openRenameModal('${n.id}')">Rename</button>
      <button class="note-act-btn" style="padding:5px 8px" onclick="event.stopPropagation();downloadNote('${n.id}')">Download</button>
      <button class="note-act-btn danger" style="padding:5px 8px" onclick="event.stopPropagation();openDeleteModal('${n.id}')">Delete</button>
    </div>
  `;
  div.addEventListener('click', () => openNote(n.id));
  return div;
}

function updateNotesCountMeta() {
  document.getElementById('notes-count-meta').textContent = notes.length + ' note' + (notes.length!==1?'s':'');
}

function setView(v) {
  currentView = v;
  ['grid','list','tree'].forEach(x => document.getElementById('view-'+x).classList.toggle('active', x===v));
  renderNotes();
}

function filterByTag(tag) {
  activeTag = tag;
  renderNotes();
}
function clearTagFilter() {
  activeTag = null;
  renderNotes();
}

// ============================================================
// UPLOAD
// ============================================================
function setupUploadZone() {
  const zone = document.getElementById('upload-zone');
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
  });
}

function handleFiles(files) {
  const htmlFiles = [...files].filter(f => f.name.endsWith('.html') || f.name.endsWith('.htm'));
  if (htmlFiles.length === 0) { showToast('⚠️ Only HTML files are accepted!'); return; }
  pendingFile = htmlFiles[0];
  uploadTags = [];
  document.getElementById('upload-file-name').textContent = '📄 ' + pendingFile.name;
  document.getElementById('upload-name').value = pendingFile.name.replace(/\.html?$/, '');
  renderFolderOptions('upload-folder');
  document.getElementById('upload-tags-wrap').innerHTML = '<input type="text" id="upload-tag-input" placeholder="Type a tag…" onkeydown="handleTagInput(event)">';
  document.getElementById('upload-form').style.display = '';
  navigate('upload');
}

function handleTagInput(e) {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    const val = e.target.value.trim().replace(/,/g,'');
    if (val && !uploadTags.includes(val)) {
      uploadTags.push(val);
      renderTagPills();
    }
    e.target.value = '';
  } else if (e.key === 'Backspace' && e.target.value === '' && uploadTags.length) {
    uploadTags.pop();
    renderTagPills();
  }
}

function renderTagPills() {
  const wrap = document.getElementById('upload-tags-wrap');
  const input = document.getElementById('upload-tag-input');
  wrap.innerHTML = '';
  uploadTags.forEach((tag, i) => {
    const pill = document.createElement('span');
    pill.className = 'tag-pill';
    pill.innerHTML = `${tag}<span class="tag-pill-remove" onclick="removeUploadTag(${i})">×</span>`;
    wrap.appendChild(pill);
  });
  const newInput = document.createElement('input');
  newInput.type = 'text';
  newInput.id = 'upload-tag-input';
  newInput.placeholder = 'Type a tag…';
  newInput.setAttribute('onkeydown', 'handleTagInput(event)');
  wrap.appendChild(newInput);
}
function removeUploadTag(i) { uploadTags.splice(i,1); renderTagPills(); }

function saveNote() {
  if (!pendingFile) return;
  const name = document.getElementById('upload-name').value.trim() || pendingFile.name;
  const folder = document.getElementById('upload-folder').value;
  const reader = new FileReader();
  reader.onload = async e => {
    const note = {
      id: 'n_' + Date.now(),
      name,
      folder: folder || null,
      tags: [...uploadTags],
      content: e.target.result,
      created: new Date().toISOString()
    };
    notes.push(note);
    await saveUserData();
    pendingFile = null;
    uploadTags = [];
    document.getElementById('upload-form').style.display = 'none';
    showToast('Note saved!');
    navigate('home');
    renderAll();
  };
  reader.readAsText(pendingFile);
}
function cancelUpload() {
  pendingFile = null;
  document.getElementById('upload-form').style.display = 'none';
  navigate('home');
}

// ============================================================
// NOTE VIEWER
// ============================================================
function openNote(id) {
  const note = notes.find(n => n.id === id);
  if (!note) return;
  document.getElementById('note-win-title').textContent = note.name;
  const iframe = document.getElementById('note-iframe');
  const blob = new Blob([note.content], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  iframe.src = url;
  document.getElementById('note-viewer').classList.add('open');

  // Reset window size/position
  const win = document.getElementById('note-window');
  const isMobile = window.innerWidth <= 700;
  if (isMobile) {
    win.style.cssText = 'width:92vw;height:75vh;left:4vw;top:12vh;transform:none;';
  } else {
    win.style.cssText = 'width:780px;height:560px;left:50%;top:50%;transform:translate(-50%,-50%);';
  }
  win.classList.remove('fullscreen-win');

  // Highlight in sidebar
  document.querySelectorAll('.folder-note-item').forEach(el => el.classList.remove('active'));
  const sfn = document.getElementById('sfn_'+id);
  if (sfn) sfn.classList.add('active');
}

function closeNoteViewer() {
  document.getElementById('note-viewer').classList.remove('open');
  document.getElementById('note-iframe').src = '';
  document.querySelectorAll('.folder-note-item').forEach(el => el.classList.remove('active'));
}

function toggleFullscreenWin() {
  const win = document.getElementById('note-window');
  const viewer = document.getElementById('note-viewer');
  const isFullscreen = win.classList.contains('fullscreen-win');
  
  if (!isFullscreen) {
    win.classList.add('fullscreen-win');
    win.style.cssText = '';
    // Try browser fullscreen
    if (viewer.requestFullscreen) viewer.requestFullscreen();
    else if (viewer.webkitRequestFullscreen) viewer.webkitRequestFullscreen();
  } else {
    win.classList.remove('fullscreen-win');
    // Exit browser fullscreen
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    // Restore default size
    const isMobile = window.innerWidth <= 700;
    if (isMobile) {
      win.style.cssText = 'width:92vw;height:75vh;left:4vw;top:10vh;transform:none;';
    } else {
      win.style.cssText = 'width:780px;height:560px;left:50%;top:50%;transform:translate(-50%,-50%);';
    }
  }
}

// Handle fullscreen change from browser (e.g. Escape key)
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    const win = document.getElementById('note-window');
    if (win && win.classList.contains('fullscreen-win')) {
      win.classList.remove('fullscreen-win');
      const isMobile = window.innerWidth <= 700;
      if (isMobile) {
        win.style.cssText = 'width:92vw;height:75vh;left:4vw;top:10vh;transform:none;';
      } else {
        win.style.cssText = 'width:780px;height:560px;left:50%;top:50%;transform:translate(-50%,-50%);';
      }
    }
  }
});

// Click overlay to close
document.getElementById('note-viewer').addEventListener('click', function(e) {
  if (e.target === this) closeNoteViewer();
});

// Drag & Resize
function setupDragResize() {
  const win = document.getElementById('note-window');
  const titlebar = document.getElementById('note-win-titlebar');
  const resizeHandle = document.getElementById('resize-handle');
  let dragging = false, resizing = false;
  let startX, startY, startW, startH, startLeft, startTop;

  titlebar.addEventListener('mousedown', e => {
    if (win.classList.contains('fullscreen-win')) return;
    dragging = true;
    startX = e.clientX; startY = e.clientY;
    const rect = win.getBoundingClientRect();
    startLeft = rect.left; startTop = rect.top;
    win.style.transform = 'none';
    win.style.left = startLeft + 'px';
    win.style.top = startTop + 'px';
  });
  resizeHandle.addEventListener('mousedown', e => {
    e.stopPropagation();
    resizing = true;
    startX = e.clientX; startY = e.clientY;
    const rect = win.getBoundingClientRect();
    startW = rect.width; startH = rect.height;
    startLeft = rect.left; startTop = rect.top;
    win.style.transform = 'none';
    win.style.left = startLeft + 'px';
    win.style.top = startTop + 'px';
  });
  document.addEventListener('mousemove', e => {
    if (dragging) {
      win.style.left = (startLeft + e.clientX - startX) + 'px';
      win.style.top = (startTop + e.clientY - startY) + 'px';
    } else if (resizing) {
      const newW = Math.max(320, startW + e.clientX - startX);
      const newH = Math.max(200, startH + e.clientY - startY);
      win.style.width = newW + 'px';
      win.style.height = newH + 'px';
    }
  });
  document.addEventListener('mouseup', () => { dragging = false; resizing = false; });

  // Touch drag for mobile
  titlebar.addEventListener('touchstart', e => {
    if (win.classList.contains('fullscreen-win')) return;
    const t = e.touches[0];
    dragging = true;
    startX = t.clientX; startY = t.clientY;
    const rect = win.getBoundingClientRect();
    startLeft = rect.left; startTop = rect.top;
    win.style.transform = 'none';
    win.style.left = startLeft + 'px';
    win.style.top = startTop + 'px';
  }, {passive:true});
  document.addEventListener('touchmove', e => {
    if (!dragging) return;
    const t = e.touches[0];
    win.style.left = (startLeft + t.clientX - startX) + 'px';
    win.style.top = (startTop + t.clientY - startY) + 'px';
  }, {passive:true});
  document.addEventListener('touchend', () => { dragging = false; resizing = false; });
}

// ============================================================
// RENAME / DELETE / DOWNLOAD
// ============================================================
function openRenameModal(id) {
  renameTarget = id;
  const note = notes.find(n => n.id===id);
  document.getElementById('rename-input').value = note.name;
  document.getElementById('rename-modal').classList.add('open');
  setTimeout(() => document.getElementById('rename-input').focus(), 50);
}
function closeRenameModal() { document.getElementById('rename-modal').classList.remove('open'); }
async function confirmRename() {
  const val = document.getElementById('rename-input').value.trim();
  if (!val) return;
  const note = notes.find(n => n.id===renameTarget);
  note.name = val;
  await saveUserData();
  closeRenameModal();
  renderAll();
  showToast('Note renamed!');
}

function openDeleteModal(id) {
  deleteTarget = id;
  const note = notes.find(n => n.id===id);
  document.getElementById('delete-note-name').textContent = note.name;
  document.getElementById('delete-modal').classList.add('open');
}
function closeDeleteModal() { document.getElementById('delete-modal').classList.remove('open'); }
async function confirmDelete() {
  notes = notes.filter(n => n.id !== deleteTarget);
  await saveUserData();
  closeDeleteModal();
  renderAll();
  showToast('Note deleted!');
}

function downloadNote(id) {
  const note = notes.find(n => n.id===id);
  if (!note) return;
  const blob = new Blob([note.content], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = note.name + '.html';
  a.click();
  showToast('Downloading…');
}

// ============================================================
// TOAST
// ============================================================
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2400);
}

// Enter key on modals
document.getElementById('rename-input').addEventListener('keydown', e => { if(e.key==='Enter') confirmRename(); });
document.getElementById('folder-name-input').addEventListener('keydown', e => { if(e.key==='Enter') createFolder(); });

// Close modals clicking overlay
['folder-modal','rename-modal','delete-modal'].forEach(id => {
  document.getElementById(id).addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('open');
  });
});
</script>
</body>
</html>
