<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>NoteZ</title>
<meta name="theme-color" content="#16161a">
<meta name="color-scheme" content="dark">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NoteZ">
<link rel="manifest" href="data:application/json,{%22name%22:%22NoteZ%22,%22short_name%22:%22NoteZ%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%230f0f11%22,%22theme_color%22:%22%237c6dfa%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20192%20192'%3E%3Crect%20width='192'%20height='192'%20rx='42'%20fill='white'/%3E%3Ctext%20x='28'%20y='158'%20font-family='Georgia,serif'%20font-weight='900'%20font-size='148'%20fill='%237c6dfa'%3EZ%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22},{%22src%22:%22data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20512%20512'%3E%3Crect%20width='512'%20height='512'%20rx='112'%20fill='white'/%3E%3Ctext%20x='60'%20y='430'%20font-family='Georgia,serif'%20font-weight='900'%20font-size='400'%20fill='%237c6dfa'%3EZ%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='7' fill='white'/><text x='4' y='26' font-family='Georgia,serif' font-weight='900' font-size='26' fill='%237c6dfa'>Z</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='white'/><text x='20' y='148' font-family='Georgia,serif' font-weight='900' font-size='140' fill='%237c6dfa'>Z</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0f0f11;--bg2:#16161a;--bg3:#1e1e24;--bg4:#26262e;
    --border:#2e2e38;--text:#e8e8f0;--text2:#9090a8;--text3:#5a5a72;
    --accent:#7c6dfa;--accent2:#a594ff;--accent-glow:rgba(124,109,250,0.18);
    --danger:#ff5b6b;--success:#3ddc97;
    --sidebar-w:260px;--radius:10px;
    --font:'Syne',sans-serif;--mono:'DM Mono',monospace;
    --transition:0.18s cubic-bezier(.4,0,.2,1);
  }
  [data-theme="light"]{--bg:#f5f4f8;--bg2:#ffffff;--bg3:#eeedf3;--bg4:#e4e3ea;--border:#d4d3e0;--text:#18181f;--text2:#55546a;--text3:#9998b0;--accent:#6b5ce7;--accent2:#8878ff;--accent-glow:rgba(107,92,231,0.12);}
  [data-theme="navy"]{--bg:#0a0f1e;--bg2:#0e1529;--bg3:#131d38;--bg4:#1a2648;--border:#1f3060;--text:#d0dcff;--text2:#7a92cc;--text3:#3a5090;--accent:#4d9fff;--accent2:#74b8ff;--accent-glow:rgba(77,159,255,0.15);}
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
  html{height:100%;overflow:hidden;background:#0f0f11;}
  body{height:100%;overflow:hidden;font-family:var(--font);background:var(--bg);color:var(--text);transition:background var(--transition),color var(--transition);}

  /* DUOTONE */
  .dt-icon{width:18px;height:18px;display:block;}
  .dt-bg{fill:var(--text3);opacity:0.25;}
  .dt-stroke{stroke:var(--text2);}
  .dt-stroke-only{stroke:var(--text2);}
  .sb-nav-btn.active .dt-bg,.mob-nav-btn.active .dt-bg{fill:var(--accent);opacity:0.3;}
  .sb-nav-btn.active .dt-stroke,.mob-nav-btn.active .dt-stroke{stroke:var(--accent2);}
  .sb-nav-btn.active .dt-stroke-only,.mob-nav-btn.active .dt-stroke-only{stroke:var(--accent2);}
  .sb-nav-btn:hover .dt-bg{fill:var(--text2);opacity:0.2;}
  .sb-nav-btn:hover .dt-stroke{stroke:var(--text);}

  /* LAYOUT */
  #app{display:flex;height:100vh;}

  /* LOADING */
  #loading-screen{position:fixed;inset:0;z-index:99999;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
  .loading-logo{font-size:2rem;font-weight:800;letter-spacing:-1px;}
  .loading-logo span{color:var(--accent);}
  .spinner{width:28px;height:28px;border-radius:50%;border:3px solid var(--border);border-top-color:var(--accent);animation:spin 0.7s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}

  /* LOGIN */
  #login-screen{position:fixed;inset:0;z-index:100;background:var(--bg);display:none;align-items:center;justify-content:center;flex-direction:column;}
  #login-screen.visible{display:flex;}
  .login-card{background:var(--bg2);border:1px solid var(--border);border-radius:18px;padding:48px 44px;width:100%;max-width:400px;text-align:center;box-shadow:0 8px 60px rgba(0,0,0,0.35);}
  .login-logo{font-size:2.6rem;font-weight:800;letter-spacing:-1px;margin-bottom:6px;}
  .login-logo span{color:var(--accent);}
  .login-sub{color:var(--text2);font-size:0.9rem;margin-bottom:32px;}
  .login-card input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px 14px;color:var(--text);font-family:var(--font);font-size:0.95rem;margin-bottom:12px;outline:none;transition:border var(--transition),box-shadow var(--transition);}
  .login-card input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
  .login-tabs{display:flex;margin-bottom:28px;border-radius:8px;overflow:hidden;border:1px solid var(--border);}
  .login-tab{flex:1;padding:10px;cursor:pointer;background:transparent;border:none;color:var(--text2);font-family:var(--font);font-size:0.9rem;transition:all var(--transition);}
  .login-tab.active{background:var(--accent);color:#fff;font-weight:600;}
  .login-err{color:var(--danger);font-size:0.83rem;margin-top:8px;min-height:18px;}

  /* SIDEBAR */
  .sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;overflow:hidden;transition:transform var(--transition);position:relative;z-index:10;}
  .sidebar.collapsed{transform:translateX(-100%);position:absolute;}
  .sidebar-logo{padding:22px 20px 14px;font-size:1.5rem;font-weight:800;letter-spacing:-0.5px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0;}
  .sidebar-logo span.z{color:var(--accent);}
  .logo-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent);}
  .sidebar-section{padding:10px 12px 4px;font-size:0.7rem;font-weight:700;letter-spacing:1.2px;color:var(--text3);text-transform:uppercase;}
  .sidebar-scroll{flex:1;overflow-y:auto;padding-bottom:10px;}
  .sidebar-scroll::-webkit-scrollbar{width:4px;}
  .sidebar-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
  .folder-header{display:flex;align-items:center;gap:7px;padding:7px 10px 7px 14px;margin:1px 8px;border-radius:7px;cursor:pointer;font-size:0.88rem;font-weight:500;color:var(--text2);transition:all var(--transition);user-select:none;}
  .folder-header:hover{background:var(--bg3);color:var(--text);}
  .folder-arrow{font-size:0.65rem;transition:transform var(--transition);flex-shrink:0;}
  .folder-arrow.open{transform:rotate(90deg);}
  .folder-children{display:none;}
  .folder-children.open{display:block;}
  .folder-note-item{padding:6px 10px 6px 12px;margin:1px 8px;border-radius:6px;cursor:pointer;font-size:0.83rem;color:var(--text3);transition:all var(--transition);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:6px;}
  .folder-note-item:hover{background:var(--bg3);color:var(--text2);}
  .folder-note-item.active{color:var(--accent2);background:var(--accent-glow);}
  .new-folder-btn{display:flex;align-items:center;gap:7px;padding:7px 14px;margin:2px 8px;border-radius:7px;cursor:pointer;font-size:0.82rem;font-weight:600;color:var(--accent2);border:1px dashed var(--border);background:transparent;width:calc(100% - 16px);transition:all var(--transition);}
  .new-folder-btn:hover{border-color:var(--accent);background:var(--accent-glow);}

  /* SIDEBAR BOTTOM NAV (desktop) */
  .sidebar-bottom-nav{display:flex;align-items:center;gap:2px;padding:8px 10px;border-top:1px solid var(--border);flex-shrink:0;background:var(--bg2);}
  .sb-nav-btn{width:36px;height:36px;border-radius:8px;border:none;background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text2);transition:all var(--transition);flex-shrink:0;}
  .sb-nav-btn:hover{background:var(--bg3);}
  .sb-nav-btn.active{background:var(--accent-glow);}
  .user-avatar{width:32px;height:32px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.85rem;color:#fff;flex-shrink:0;}

  /* MAIN */
  .main{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden;}
  .topbar{height:54px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:0 16px;flex-shrink:0;z-index:5;}
  .topbar-btn{width:34px;height:34px;border-radius:7px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;cursor:pointer;color:var(--text2);transition:all var(--transition);flex-shrink:0;}
  .topbar-btn:hover{background:var(--bg3);color:var(--text);}
  .topbar-title{font-weight:700;font-size:1rem;flex:1;}
  .topbar-actions{display:flex;align-items:center;gap:6px;}
  .view-toggle{display:flex;background:var(--bg3);border-radius:7px;padding:2px;gap:1px;}
  .view-btn{width:28px;height:28px;border-radius:5px;border:none;background:transparent;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition);}
  .view-btn.active{background:var(--bg2);color:var(--accent);box-shadow:0 1px 4px rgba(0,0,0,0.2);}

  /* CONTENT */
  .content-area{flex:1;overflow-y:auto;padding:24px 28px;}
  .content-area::-webkit-scrollbar{width:5px;}
  .content-area::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
  .page-header{margin-bottom:24px;}
  .page-title{font-size:1.7rem;font-weight:800;letter-spacing:-0.5px;}
  .page-meta{color:var(--text3);font-size:0.82rem;margin-top:5px;font-family:var(--mono);}

  /* TAGS */
  .tag-filter-bar{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:20px;align-items:center;}
  .tag-chip{padding:4px 12px;border-radius:20px;font-size:0.78rem;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--bg3);color:var(--text2);transition:all var(--transition);}
  .tag-chip:hover{border-color:var(--accent);color:var(--accent);}
  .tag-chip.active{background:var(--accent);border-color:var(--accent);color:#fff;}
  .tag-chip.all{border-style:dashed;}
  .active-tag-indicator{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--accent-glow);border-radius:8px;font-size:0.84rem;color:var(--accent2);margin-bottom:16px;}
  .clear-tag{cursor:pointer;font-size:0.9rem;margin-left:auto;}

  /* NOTES */
  .notes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;}
  .notes-list{display:flex;flex-direction:column;gap:8px;}
  .note-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;cursor:pointer;transition:all var(--transition);position:relative;overflow:hidden;}
  .note-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent);transform:scaleX(0);transform-origin:left;transition:transform var(--transition);}
  .note-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,0,0,0.18);}
  .note-card:hover::before{transform:scaleX(1);}
  .note-card-icon{margin-bottom:10px;}
  .note-card-name{font-weight:700;font-size:0.95rem;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .note-card-meta{display:flex;flex-wrap:wrap;gap:5px;}
  .note-tag{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:0.72rem;font-weight:600;background:var(--accent-glow);color:var(--accent2);}
  .note-folder-path{font-size:0.72rem;color:var(--text3);font-family:var(--mono);margin-top:4px;}
  .note-card-actions{display:flex;gap:5px;margin-top:12px;opacity:0;transition:opacity var(--transition);}
  .note-card:hover .note-card-actions{opacity:1;}
  .note-act-btn{flex:1;padding:5px 8px;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:0.75rem;font-family:var(--font);cursor:pointer;transition:all var(--transition);font-weight:600;}
  .note-act-btn:hover{background:var(--bg4);color:var(--text);}
  .note-act-btn.danger:hover{background:rgba(255,91,107,0.15);color:var(--danger);border-color:var(--danger);}
  .note-list-item{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px 16px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all var(--transition);}
  .note-list-item:hover{border-color:var(--accent);background:var(--bg3);}
  .note-list-icon{flex-shrink:0;}
  .note-list-name{font-weight:600;font-size:0.92rem;flex:1;}
  .note-list-tags{display:flex;gap:5px;flex-wrap:wrap;}
  .note-list-path{font-size:0.75rem;color:var(--text3);font-family:var(--mono);}
  .note-list-actions{display:flex;gap:5px;opacity:0;transition:opacity var(--transition);}
  .note-list-item:hover .note-list-actions{opacity:1;}

  /* BUTTONS */
  .btn-primary{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 16px;font-family:var(--font);font-weight:700;font-size:0.88rem;cursor:pointer;transition:all var(--transition);display:inline-flex;align-items:center;gap:6px;}
  .btn-primary:hover{opacity:0.88;transform:translateY(-1px);}
  .btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
  .btn-secondary{background:var(--bg3);color:var(--text2);border:1px solid var(--border);border-radius:8px;padding:8px 14px;font-family:var(--font);font-weight:600;font-size:0.88rem;cursor:pointer;transition:all var(--transition);}
  .btn-secondary:hover{background:var(--bg4);color:var(--text);}

  /* UPLOAD */
  .upload-zone{border:2px dashed var(--border);border-radius:12px;padding:32px 24px;text-align:center;cursor:pointer;transition:all var(--transition);margin-bottom:24px;background:var(--bg2);}
  .upload-zone:hover,.upload-zone.dragover{border-color:var(--accent);background:var(--accent-glow);}
  .upload-zone .upload-icon{margin-bottom:10px;display:flex;justify-content:center;}
  .upload-zone p{color:var(--text2);font-size:0.88rem;}
  .upload-zone strong{color:var(--accent);}

  /* NOTE VIEWER */
  #note-viewer{display:none;position:fixed;inset:0;z-index:50;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);}
  #note-viewer.open{display:flex;}
  .note-window{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:14px;box-shadow:0 20px 80px rgba(0,0,0,0.5);display:flex;flex-direction:column;overflow:hidden;min-width:320px;min-height:200px;}
  .note-window-titlebar{height:42px;background:var(--bg3);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;padding:0 12px;cursor:grab;user-select:none;flex-shrink:0;}
  .note-window-titlebar:active{cursor:grabbing;}
  .win-title{flex:1;font-size:0.88rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .win-btn{width:26px;height:26px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition);flex-shrink:0;}
  .win-btn.close{background:var(--danger);color:#fff;}
  .win-btn.fullscreen{background:var(--success);color:#fff;}
  .win-btn:hover{opacity:0.8;transform:scale(1.1);}
  .note-window-body{flex:1;overflow:hidden;}
  .note-window-body iframe{width:100%;height:100%;border:none;background:#fff;}
  .resize-handle{position:absolute;bottom:0;right:0;width:18px;height:18px;cursor:se-resize;display:flex;align-items:flex-end;justify-content:flex-end;padding:3px;z-index:2;}
  .note-window.fullscreen-win{inset:0!important;width:100%!important;height:100%!important;border-radius:0;}
  .note-window.fullscreen-win .resize-handle{display:none;}

  /* MODALS */
  .modal-overlay{display:none;position:fixed;inset:0;z-index:60;background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);align-items:center;justify-content:center;}
  .modal-overlay.open{display:flex;}
  .modal{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:28px 28px 24px;width:90%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.4);}
  .modal h3{font-size:1.15rem;font-weight:800;margin-bottom:16px;}
  .modal input,.modal select{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-family:var(--font);font-size:0.9rem;margin-bottom:10px;outline:none;transition:border var(--transition);}
  .modal input:focus,.modal select:focus{border-color:var(--accent);}
  .modal-actions{display:flex;gap:8px;margin-top:6px;justify-content:flex-end;}
  .modal label{font-size:0.8rem;color:var(--text2);display:block;margin-bottom:4px;font-weight:600;}

  /* TAGS INPUT */
  .tags-input-wrap{display:flex;flex-wrap:wrap;gap:5px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:7px;margin-bottom:10px;cursor:text;}
  .tags-input-wrap:focus-within{border-color:var(--accent);}
  .tag-pill{background:var(--accent);color:#fff;border-radius:20px;padding:2px 8px 2px 10px;font-size:0.77rem;font-weight:600;display:inline-flex;align-items:center;gap:4px;}
  .tag-pill-remove{cursor:pointer;opacity:0.7;}
  .tag-pill-remove:hover{opacity:1;}
  .tags-input-wrap input{border:none;background:transparent;outline:none;font-family:var(--font);color:var(--text);font-size:0.88rem;flex:1;min-width:80px;}

  /* SETTINGS */
  .settings-section-title{font-size:0.7rem;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--text3);margin-bottom:8px;margin-top:8px;}
  .theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
  .theme-opt{border-radius:9px;padding:12px 8px;text-align:center;cursor:pointer;border:2px solid transparent;font-size:0.8rem;font-weight:700;transition:all var(--transition);}
  .theme-opt:hover{transform:scale(1.03);}
  .theme-opt.active{border-color:var(--accent);}
  .theme-opt.dark{background:#0f0f11;color:#e8e8f0;}
  .theme-opt.light{background:#f5f4f8;color:#18181f;}
  .theme-opt.navy{background:#0a0f1e;color:#d0dcff;}
  .accent-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
  .accent-opt{height:36px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all var(--transition);}
  .accent-opt:hover{transform:scale(1.05);}
  .accent-opt.active{border-color:var(--text);}

  /* EMPTY STATE */
  .empty-state{text-align:center;padding:60px 20px;color:var(--text3);}
  .empty-state .empty-icon{display:flex;justify-content:center;margin-bottom:14px;}
  .empty-state p{font-size:0.9rem;}

  /* TOAST */
  #toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px 18px;font-size:0.88rem;font-weight:600;z-index:200;transition:transform 0.3s ease;pointer-events:none;white-space:nowrap;}
  #toast.show{transform:translateX(-50%) translateY(0);}

  /* MOBILE BOTTOM NAV */
  #mobile-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:30;background:var(--bg2);border-top:1px solid var(--border);padding:6px 4px 6px;padding-bottom:calc(6px + env(safe-area-inset-bottom, 0px));justify-content:space-around;align-items:center;opacity:0;transition:opacity 0.2s;}
  #mobile-bottom-nav.app-ready{opacity:1;}
  .mob-nav-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 10px;border-radius:10px;border:none;background:transparent;cursor:pointer;color:var(--text3);transition:all var(--transition);flex:1;}
  .mob-nav-btn.active{color:var(--accent2);}
  .mob-nav-btn span{font-size:0.62rem;font-weight:700;letter-spacing:0.3px;}
  /* Profile avatar in mobile nav */
  .mob-avatar-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:4px 10px;border-radius:10px;border:none;background:transparent;cursor:pointer;flex:1;}
  .mob-avatar-circle{width:28px;height:28px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.78rem;color:#fff;}
  .mob-avatar-btn span{font-size:0.62rem;font-weight:700;color:var(--text3);letter-spacing:0.3px;}

  /* PROFILE TRAY */
  #profile-tray-overlay{display:none;position:fixed;inset:0;z-index:50;background:rgba(0,0,0,0.45);backdrop-filter:blur(3px);}
  #profile-tray-overlay.open{display:block;}
  #profile-tray{
    display:none;
    position:fixed;bottom:0;left:0;right:0;z-index:51;
    background:var(--bg2);border-top:1px solid var(--border);
    border-radius:20px 20px 0 0;
    padding:0 0 calc(env(safe-area-inset-bottom, 0px) + 16px);
    transform:translateY(100%);transition:transform 0.3s cubic-bezier(.4,0,.2,1);
  }
  #profile-tray.open{display:block;transform:translateY(0);}
  #profile-tray.closing{display:block;transform:translateY(100%);}
  .tray-handle{width:36px;height:4px;border-radius:2px;background:var(--border);margin:12px auto 0;}
  .tray-user{display:flex;align-items:center;gap:12px;padding:18px 20px 14px;}
  .tray-avatar{width:44px;height:44px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.1rem;color:#fff;flex-shrink:0;}
  .tray-user-name{font-weight:800;font-size:0.95rem;}
  .tray-user-email{font-size:0.75rem;color:var(--text2);margin-top:1px;}
  .tray-divider{height:1px;background:var(--border);margin:0 20px;}
  .tray-section-label{font-size:0.65rem;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--text3);padding:14px 20px 8px;}
  .tray-theme-row{display:flex;gap:8px;padding:0 20px 14px;}
  .tray-theme-btn{flex:1;padding:10px 4px;border-radius:10px;border:1.5px solid var(--border);background:transparent;font-family:var(--font);font-size:0.78rem;font-weight:700;color:var(--text2);cursor:pointer;transition:all var(--transition);}
  .tray-theme-btn.active{border-color:var(--accent);color:var(--accent2);background:var(--accent-glow);}
  .tray-theme-btn.t-dark{background:#0f0f11;color:#e8e8f0;}
  .tray-theme-btn.t-dark.active{border-color:var(--accent);}
  .tray-theme-btn.t-light{background:#f5f4f8;color:#18181f;}
  .tray-theme-btn.t-navy{background:#0a0f1e;color:#d0dcff;}
  .tray-accent-row{display:flex;gap:10px;padding:0 20px 16px;align-items:center;}
  .tray-accent-dot{width:32px;height:32px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:all var(--transition);}
  .tray-accent-dot:hover{transform:scale(1.1);}
  .tray-accent-dot.active{border-color:var(--text);}
  .tray-action-btn{display:flex;align-items:center;gap:12px;width:100%;padding:14px 20px;border:none;background:transparent;font-family:var(--font);font-size:0.92rem;font-weight:600;color:var(--text2);cursor:pointer;transition:background var(--transition);}
  .tray-action-btn:hover{background:var(--bg3);}
  .tray-action-btn.danger{color:var(--danger);}
  .tray-action-btn svg{flex-shrink:0;}

  /* WIN BTN new-window */
  .win-btn.newwin{background:var(--bg4);color:var(--text2);}
  .win-btn.newwin:hover{background:var(--bg3);color:var(--text);opacity:1;transform:none;}

  /* MOBILE */
  @media(max-width:700px){
    .sidebar{position:fixed;left:0;top:0;bottom:0;z-index:20;transform:translateX(-100%);transition:transform 0.25s cubic-bezier(.4,0,.2,1);}
    .sidebar.mobile-open{transform:translateX(0);}
    .sidebar-bottom-nav{display:none;}
    #mobile-bottom-nav{display:flex;}
    .mobile-overlay{display:none;position:fixed;inset:0;z-index:15;background:rgba(0,0,0,0.4);}
    .mobile-overlay.open{display:block;}
    .notes-grid{grid-template-columns:1fr 1fr;}
    .content-area{padding:16px 16px calc(80px + env(safe-area-inset-bottom, 0px));}
    .note-window{width:92vw!important;height:75vh!important;left:4vw!important;top:10vh!important;transform:none!important;}
    #toast{bottom:90px;}
    .topbar-btn#sidebar-toggle-btn{display:flex;}
  }
  @media(max-width:420px){.notes-grid{grid-template-columns:1fr;}}
  ::-webkit-scrollbar{width:5px;height:5px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
  .page-hidden{display:none!important;}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen">
  <div class="loading-logo">Note<span>Z</span></div>
  <div class="spinner"></div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">Note<span class="z">Z</span></div>
    <div class="login-sub">Your personal HTML notes workspace</div>
    <div class="login-tabs">
      <button class="login-tab active" id="tab-login" onclick="switchLoginTab('login')">Sign In</button>
      <button class="login-tab" id="tab-signup" onclick="switchLoginTab('signup')">Sign Up</button>
    </div>
    <div id="login-form">
      <input type="email" id="login-email" placeholder="Email" autocomplete="email">
      <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
      <button class="btn-primary" id="login-btn" style="width:100%;margin-top:6px;padding:13px" onclick="doLogin()">Sign In →</button>
      <div class="login-err" id="login-err"></div>
    </div>
    <div id="signup-form" style="display:none">
      <input type="text" id="signup-displayname" placeholder="Display name">
      <input type="email" id="signup-email" placeholder="Email">
      <input type="password" id="signup-password" placeholder="Password (min 6 chars)">
      <input type="password" id="signup-confirm" placeholder="Confirm password">
      <button class="btn-primary" id="signup-btn" style="width:100%;margin-top:6px;padding:13px" onclick="doSignup()">Create Account →</button>
      <div class="login-err" id="signup-err"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileSidebar()"></div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo"><span class="logo-dot"></span>Note<span class="z">Z</span></div>
    <div class="sidebar-scroll">
      <div style="height:8px"></div>
      <div class="sidebar-section">Folders</div>
      <div id="folder-tree"></div>
      <button class="new-folder-btn" onclick="openNewFolderModal()">
        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New Folder
      </button>
    </div>
    <!-- Desktop bottom nav -->
    <div class="sidebar-bottom-nav">
      <div class="user-avatar" id="user-avatar-text" style="cursor:default">U</div>
      <button class="sb-nav-btn active" id="nav-home" onclick="navigate('home')" title="All Notes">
        <svg viewBox="0 0 24 24" class="dt-icon"><path class="dt-bg" d="M3 10.5L12 3l9 7.5V20a1 1 0 01-1 1H4a1 1 0 01-1-1V10.5z"/><path class="dt-stroke" d="M3 10.5L12 3l9 7.5" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path class="dt-stroke" d="M9 21v-6h6v6" fill="none" stroke-width="1.8" stroke-linecap="round"/></svg>
      </button>
      <button class="sb-nav-btn" id="nav-upload" onclick="navigate('upload')" title="Upload">
        <svg viewBox="0 0 24 24" class="dt-icon"><rect class="dt-bg" x="3" y="15" width="18" height="6" rx="1"/><path class="dt-stroke" d="M12 3v12M7 8l5-5 5 5" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button class="sb-nav-btn" id="nav-settings" onclick="navigate('settings')" title="Settings">
        <svg viewBox="0 0 24 24" class="dt-icon"><circle class="dt-bg" cx="12" cy="12" r="9"/><circle class="dt-stroke-only" cx="12" cy="12" r="3" fill="none" stroke-width="1.8"/><path class="dt-stroke" d="M12 5v2M12 17v2M5 12H3M21 12h-2M7.05 7.05L5.64 5.64M18.36 18.36l-1.41-1.41M7.05 16.95l-1.41 1.41M18.36 5.64l-1.41 1.41" fill="none" stroke-width="1.8" stroke-linecap="round"/></svg>
      </button>
      <button class="sb-nav-btn" onclick="doLogout()" title="Sign out" style="margin-left:auto">
        <svg viewBox="0 0 24 24" class="dt-icon"><rect class="dt-bg" x="3" y="3" width="10" height="18" rx="1"/><path class="dt-stroke" d="M15 8l4 4-4 4M9 12h10" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="topbar">
      <button class="topbar-btn" onclick="toggleSidebar()">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="topbar-title" id="topbar-title">All Notes</div>
      <div class="topbar-actions">
        <div class="view-toggle" id="view-toggle">
          <button class="view-btn active" id="view-grid" onclick="setView('grid')" title="Grid">
            <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          </button>
          <button class="view-btn" id="view-list" onclick="setView('list')" title="List">
            <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="3.5" cy="6" r="1" fill="currentColor"/><circle cx="3.5" cy="12" r="1" fill="currentColor"/><circle cx="3.5" cy="18" r="1" fill="currentColor"/></svg>
          </button>
          <button class="view-btn" id="view-tree" onclick="setView('tree')" title="Folder Tree">
            <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 4h7v4H3zM14 4h7v4h-7zM14 16h7v4h-7z"/><path d="M6 8v4M6 12h8M17.5 12v4"/></svg>
          </button>
        </div>
        <button class="btn-primary" onclick="navigate('upload')" style="padding:7px 13px;font-size:0.82rem">+ Upload</button>
      </div>
    </div>

    <!-- HOME -->
    <div id="page-home" class="content-area">
      <div class="page-header">
        <div class="page-title">All Notes</div>
        <div class="page-meta" id="notes-count-meta">0 notes</div>
      </div>
      <div id="tag-filter-bar" class="tag-filter-bar"></div>
      <div id="active-tag-indicator" class="active-tag-indicator" style="display:none">
        <span>Filtering by: <strong id="active-tag-label"></strong></span>
        <span class="clear-tag" onclick="clearTagFilter()">✕</span>
      </div>
      <div id="notes-container"></div>
      <div id="empty-state" class="empty-state" style="display:none">
        <div class="empty-icon"><svg viewBox="0 0 64 64" width="52" height="52"><path d="M8 20h48v36a2 2 0 01-2 2H10a2 2 0 01-2-2V20z" fill="var(--accent)" opacity="0.12"/><path d="M8 20l8-12h16l4 6h20a2 2 0 012 2" fill="none" stroke="var(--text3)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M24 40h16M24 48h10" fill="none" stroke="var(--text3)" stroke-width="2" stroke-linecap="round"/></svg></div>
        <p>No notes yet. Upload some HTML files to get started!</p>
      </div>
    </div>

    <!-- UPLOAD -->
    <div id="page-upload" class="content-area page-hidden">
      <div class="page-header">
        <div class="page-title">Upload Note</div>
        <div class="page-meta">Drop HTML files to add them to NoteZ</div>
      </div>
      <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
        <div class="upload-icon"><svg viewBox="0 0 48 48" width="44" height="44"><rect x="6" y="28" width="36" height="14" rx="3" fill="var(--accent)" opacity="0.18"/><path d="M24 6v26M14 16l10-10 10 10" fill="none" stroke="var(--accent2)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
        <p><strong>Click or drag & drop</strong> HTML files here</p>
        <p style="margin-top:6px;font-size:0.8rem;color:var(--text3)">Only .html files are accepted</p>
      </div>
      <input type="file" id="file-input" accept=".html,.htm" multiple style="display:none" onchange="handleFiles(this.files)">
      <div id="upload-form" style="display:none">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px 22px;margin-bottom:14px">
          <div id="upload-file-name" style="font-weight:700;font-size:1rem;margin-bottom:16px"></div>
          <label>Note Name</label>
          <input type="text" id="upload-name" placeholder="Name your note">
          <label>Folder</label>
          <select id="upload-folder"><option value="">— No folder —</option></select>
          <label>Tags (press Enter to add)</label>
          <div class="tags-input-wrap" id="upload-tags-wrap" onclick="document.getElementById('upload-tag-input').focus()">
            <input type="text" id="upload-tag-input" placeholder="Type a tag…" onkeydown="handleTagInput(event)">
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn-primary" id="save-note-btn" onclick="saveNote()">Save Note</button>
            <button class="btn-secondary" onclick="cancelUpload()">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="page-settings" class="content-area page-hidden">
      <div class="page-header"><div class="page-title">Settings</div></div>
      <div class="settings-section-title">Theme</div>
      <div class="theme-grid">
        <div class="theme-opt dark active" data-theme="dark" onclick="setTheme('dark')">Dark</div>
        <div class="theme-opt light" data-theme="light" onclick="setTheme('light')">Light</div>
        <div class="theme-opt navy" data-theme="navy" onclick="setTheme('navy')">Navy</div>
      </div>
      <div class="settings-section-title" style="margin-top:20px">Accent Color</div>
      <div class="accent-grid">
        <div class="accent-opt active" data-accent="purple" style="background:linear-gradient(135deg,#7c6dfa,#a594ff)" onclick="setAccent('purple')"></div>
        <div class="accent-opt" data-accent="blue" style="background:linear-gradient(135deg,#3b82f6,#60a5fa)" onclick="setAccent('blue')"></div>
        <div class="accent-opt" data-accent="green" style="background:linear-gradient(135deg,#10b981,#34d399)" onclick="setAccent('green')"></div>
        <div class="accent-opt" data-accent="orange" style="background:linear-gradient(135deg,#f59e0b,#fbbf24)" onclick="setAccent('orange')"></div>
      </div>
    </div>
  </div>
</div>

<!-- MOBILE BOTTOM NAV -->
<div id="mobile-bottom-nav">
  <button class="mob-nav-btn active" id="mob-nav-home" onclick="navigate('home')">
    <svg viewBox="0 0 24 24" width="22" height="22"><path class="dt-bg" d="M3 10.5L12 3l9 7.5V20a1 1 0 01-1 1H4a1 1 0 01-1-1V10.5z"/><path class="dt-stroke" d="M3 10.5L12 3l9 7.5" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path class="dt-stroke" d="M9 21v-6h6v6" fill="none" stroke-width="1.8" stroke-linecap="round"/></svg>
    <span>Home</span>
  </button>
  <button class="mob-nav-btn" id="mob-nav-upload" onclick="navigate('upload')">
    <svg viewBox="0 0 24 24" width="22" height="22"><rect class="dt-bg" x="3" y="15" width="18" height="6" rx="1"/><path class="dt-stroke" d="M12 3v12M7 8l5-5 5 5" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <span>Upload</span>
  </button>
  <button class="mob-nav-btn" id="mob-nav-settings" onclick="navigate('settings')">
    <svg viewBox="0 0 24 24" width="22" height="22"><circle class="dt-bg" cx="12" cy="12" r="9"/><circle class="dt-stroke-only" cx="12" cy="12" r="3" fill="none" stroke-width="1.8"/><path class="dt-stroke" d="M12 5v2M12 17v2M5 12H3M21 12h-2" fill="none" stroke-width="1.8" stroke-linecap="round"/></svg>
    <span>Settings</span>
  </button>
  <!-- Profile avatar — opens tray -->
  <button class="mob-avatar-btn" onclick="openProfileTray()" id="mob-avatar-btn">
    <div class="mob-avatar-circle" id="mob-avatar-circle">U</div>
    <span>Profile</span>
  </button>
</div>

<!-- PROFILE TRAY OVERLAY -->
<div id="profile-tray-overlay" onclick="closeProfileTray()"></div>

<!-- PROFILE TRAY -->
<div id="profile-tray">
  <div class="tray-handle"></div>
  <div class="tray-user">
    <div class="tray-avatar" id="tray-avatar">U</div>
    <div>
      <div class="tray-user-name" id="tray-name">User</div>
      <div class="tray-user-email" id="tray-email"></div>
    </div>
  </div>
  <div class="tray-divider"></div>
  <div class="tray-section-label">Theme</div>
  <div class="tray-theme-row">
    <button class="tray-theme-btn t-dark active" data-theme="dark" onclick="setTheme('dark');syncTrayTheme()">Dark</button>
    <button class="tray-theme-btn t-light" data-theme="light" onclick="setTheme('light');syncTrayTheme()">Light</button>
    <button class="tray-theme-btn t-navy" data-theme="navy" onclick="setTheme('navy');syncTrayTheme()">Navy</button>
  </div>
  <div class="tray-section-label">Accent</div>
  <div class="tray-accent-row">
    <div class="tray-accent-dot active" data-accent="purple" style="background:linear-gradient(135deg,#7c6dfa,#a594ff)" onclick="setAccent('purple');syncTrayAccent()"></div>
    <div class="tray-accent-dot" data-accent="blue" style="background:linear-gradient(135deg,#3b82f6,#60a5fa)" onclick="setAccent('blue');syncTrayAccent()"></div>
    <div class="tray-accent-dot" data-accent="green" style="background:linear-gradient(135deg,#10b981,#34d399)" onclick="setAccent('green');syncTrayAccent()"></div>
    <div class="tray-accent-dot" data-accent="orange" style="background:linear-gradient(135deg,#f59e0b,#fbbf24)" onclick="setAccent('orange');syncTrayAccent()"></div>
  </div>
  <div class="tray-divider"></div>
  <button class="tray-action-btn" id="tray-install-btn" onclick="installPWA()" style="display:none">
    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v13M7 10l5 5 5-5"/><path d="M3 18h18v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z"/></svg>
    Add to Home Screen
  </button>
  <button class="tray-action-btn danger" onclick="closeProfileTray();doLogout()">
    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="10" height="18" rx="1" stroke="var(--danger)"/><path d="M15 8l4 4-4 4M9 12h10" stroke="var(--danger)"/></svg>
    Sign out
  </button>
  <div style="height:8px"></div>
</div>

<!-- NOTE VIEWER -->
<div id="note-viewer">
  <div class="note-window" id="note-window" style="width:780px;height:560px;left:50%;top:50%;transform:translate(-50%,-50%)">
    <div class="note-window-titlebar" id="note-win-titlebar">
      <span class="win-title" id="note-win-title">Note</span>
      <button class="win-btn newwin" id="win-newwin-btn" onclick="openNoteInNewWindow()" title="Open in new window">
        <svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
      </button>
      <button class="win-btn fullscreen" onclick="toggleFullscreenWin()" title="Fullscreen"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M8 3H5a2 2 0 00-2 2v3M16 3h3a2 2 0 012 2v3M21 16v3a2 2 0 01-2 2h-3M8 21H5a2 2 0 01-2-2v-3"/></svg></button>
      <button class="win-btn close" onclick="closeNoteViewer()" title="Close"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="note-window-body"><iframe id="note-iframe" sandbox="allow-scripts allow-same-origin"></iframe></div>
    <div class="resize-handle" id="resize-handle"><svg viewBox="0 0 10 10" width="10" height="10" fill="none" stroke="var(--text3)" stroke-width="1.2" stroke-linecap="round"><line x1="9" y1="1" x2="1" y2="9"/><line x1="9" y1="5" x2="5" y2="9"/></svg></div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="folder-modal">
  <div class="modal">
    <h3>New Folder</h3>
    <label>Folder Name</label><input type="text" id="folder-name-input" placeholder="e.g. Projects">
    <label>Parent Folder (optional)</label><select id="folder-parent-select"><option value="">— Root —</option></select>
    <div class="modal-actions"><button class="btn-secondary" onclick="closeFolderModal()">Cancel</button><button class="btn-primary" onclick="createFolder()">Create</button></div>
  </div>
</div>
<div class="modal-overlay" id="rename-modal">
  <div class="modal">
    <h3>Rename Note</h3>
    <label>New Name</label><input type="text" id="rename-input" placeholder="New name">
    <div class="modal-actions"><button class="btn-secondary" onclick="closeRenameModal()">Cancel</button><button class="btn-primary" onclick="confirmRename()">Rename</button></div>
  </div>
</div>
<div class="modal-overlay" id="delete-modal">
  <div class="modal">
    <h3>Delete Note</h3>
    <p style="color:var(--text2);font-size:0.9rem;margin-bottom:16px">Are you sure you want to delete <strong id="delete-note-name"></strong>? This cannot be undone.</p>
    <div class="modal-actions"><button class="btn-secondary" onclick="closeDeleteModal()">Cancel</button><button class="btn-primary" style="background:var(--danger)" onclick="confirmDelete()">Delete</button></div>
  </div>
</div>

<script type="module">
import { initializeApp }                                          from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword,
         signInWithEmailAndPassword, signOut,
         onAuthStateChanged, updateProfile }                      from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc,
         collection, getDocs, addDoc, deleteDoc }                 from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:            "AIzaSyBKK7lSt7_S9zhibXEkpAl75gBUWxKcwmA",
  authDomain:        "notez-e2e36.firebaseapp.com",
  databaseURL:       "https://notez-e2e36-default-rtdb.firebaseio.com",
  projectId:         "notez-e2e36",
  storageBucket:     "notez-e2e36.firebasestorage.app",
  messagingSenderId: "40028336367",
  appId:             "1:40028336367:web:fb1dd35125899ef0d1ab1a"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// Immediately detect file:// and warn — Firebase won't work there
if (location.protocol === 'file:' || location.protocol === 'content:') {
  setTimeout(() => {
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('mobile-bottom-nav').classList.add('app-ready');
    document.getElementById('login-screen').classList.add('visible');
    document.getElementById('login-err').style.cssText = 'color:#f4a24b;font-size:0.82rem;margin-top:10px;line-height:1.5;';
    document.getElementById('login-err').innerHTML =
      '⚠️ <strong>NoteZ needs to be hosted online.</strong><br>You\'re opening it as a local file. Please upload it to GitHub Pages and open from there.';
  }, 100);
}

// ─── STATE ───────────────────────────────────────────────────
let currentUser = null;
let notes = [], folders = [];
let settings = { theme:'dark', accent:'purple' };
let currentView = 'grid', activeTag = null, currentPage = 'home';
let uploadTags = [], pendingFile = null, renameTarget = null, deleteTarget = null;

const userDoc    = ()  => doc(db, 'users', currentUser.uid);
const notesCol   = ()  => collection(db, 'users', currentUser.uid, 'notes');
const foldersCol = ()  => collection(db, 'users', currentUser.uid, 'folders');

// ─── LOAD USER DATA ──────────────────────────────────────────
async function loadUserData() {
  const snap = await getDoc(userDoc());
  if (snap.exists()) {
    settings = snap.data().settings || { theme:'dark', accent:'purple' };
  } else {
    await setDoc(userDoc(), { settings: { theme:'dark', accent:'purple' } });
  }
  const [ns, fs] = await Promise.all([getDocs(notesCol()), getDocs(foldersCol())]);
  notes   = ns.docs.map(d => ({ id:d.id, ...d.data() }));
  folders = fs.docs.map(d => ({ id:d.id, ...d.data() }));
}

// ─── AUTH STATE ──────────────────────────────────────────────
// Fallback: if Firebase doesn't respond in 5s (e.g. file:// URL), show error
const authTimeout = setTimeout(() => {
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('mobile-bottom-nav').classList.add('app-ready');
  document.getElementById('login-screen').classList.add('visible');
  document.getElementById('login-err').textContent =
    '⚠️ NoteZ must be opened from a hosted URL (not a local file). Please visit shanbruh.github.io/NoteZ to use it.';
}, 5000);

onAuthStateChanged(auth, async (user) => {
  clearTimeout(authTimeout);
  document.getElementById('loading-screen').style.display = 'none';
  // Now safe to show mobile nav
  document.getElementById('mobile-bottom-nav').classList.add('app-ready');
  if (user) {
    currentUser = user;
    await loadUserData();
    document.getElementById('login-screen').classList.remove('visible');
    document.getElementById('app').style.display = 'flex';
    const name    = user.displayName || user.email || 'User';
    const initial = name[0].toUpperCase();
    // Desktop sidebar avatar
    document.getElementById('user-avatar-text').textContent = initial;
    document.getElementById('user-avatar-text').title = name;
    // Mobile nav avatar
    document.getElementById('mob-avatar-circle').textContent = initial;
    // Profile tray
    document.getElementById('tray-avatar').textContent = initial;
    document.getElementById('tray-name').textContent = user.displayName || 'User';
    document.getElementById('tray-email').textContent = user.email || '';
    applySettings();
    syncTrayTheme();
    syncTrayAccent();
    renderAll();
  } else {
    currentUser = null;
    document.getElementById('login-screen').classList.add('visible');
    document.getElementById('app').style.display = 'none';
  }
});

// ─── AUTH FUNCTIONS ──────────────────────────────────────────
window.switchLoginTab = (tab) => {
  document.getElementById('tab-login').classList.toggle('active', tab==='login');
  document.getElementById('tab-signup').classList.toggle('active', tab==='signup');
  document.getElementById('login-form').style.display  = tab==='login'  ? '' : 'none';
  document.getElementById('signup-form').style.display = tab==='signup' ? '' : 'none';
};

window.doLogin = async () => {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-password').value;
  const err   = document.getElementById('login-err');
  const btn   = document.getElementById('login-btn');
  if (!email||!pass) { err.textContent='Please fill in all fields.'; return; }
  btn.disabled=true; btn.textContent='Signing in…';
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    err.textContent='';
  } catch(e) {
    err.textContent = e.code==='auth/invalid-credential' ? 'Wrong email or password.' : e.message;
  } finally { btn.disabled=false; btn.textContent='Sign In →'; }
};

window.doSignup = async () => {
  const name  = document.getElementById('signup-displayname').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const pass  = document.getElementById('signup-password').value;
  const conf  = document.getElementById('signup-confirm').value;
  const err   = document.getElementById('signup-err');
  const btn   = document.getElementById('signup-btn');
  if (!name||!email||!pass) { err.textContent='All fields are required.'; return; }
  if (pass!==conf)           { err.textContent='Passwords do not match.'; return; }
  if (pass.length<6)         { err.textContent='Password must be at least 6 characters.'; return; }
  btn.disabled=true; btn.textContent='Creating…';
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user, { displayName: name });
    err.textContent='';
  } catch(e) {
    err.textContent = e.code==='auth/email-already-in-use' ? 'Email already in use.' : e.message;
  } finally { btn.disabled=false; btn.textContent='Create Account →'; }
};

window.doLogout = async () => { await signOut(auth); };

// ─── SETTINGS ────────────────────────────────────────────────
const ACCENTS = {
  purple:['#7c6dfa','#a594ff','rgba(124,109,250,0.18)'],
  blue:  ['#3b82f6','#60a5fa','rgba(59,130,246,0.15)'],
  green: ['#10b981','#34d399','rgba(16,185,129,0.15)'],
  orange:['#f59e0b','#fbbf24','rgba(245,158,11,0.15)'],
};
function applySettings() {
  document.documentElement.setAttribute('data-theme', settings.theme||'dark');
  const a = ACCENTS[settings.accent]||ACCENTS.purple;
  document.documentElement.style.setProperty('--accent',      a[0]);
  document.documentElement.style.setProperty('--accent2',     a[1]);
  document.documentElement.style.setProperty('--accent-glow', a[2]);
  document.querySelectorAll('.theme-opt').forEach(el => el.classList.toggle('active', el.dataset.theme===settings.theme));
  document.querySelectorAll('.accent-opt').forEach(el => el.classList.toggle('active', el.dataset.accent===settings.accent));
}
window.setTheme  = async(t) => { settings.theme=t;  applySettings(); await updateDoc(userDoc(),{settings}); };
window.setAccent = async(n) => { settings.accent=n; applySettings(); await updateDoc(userDoc(),{settings}); };

// ─── NAVIGATION ──────────────────────────────────────────────
window.navigate = (page) => {
  currentPage = page;
  ['home','upload','settings'].forEach(p => {
    document.getElementById('page-'+p).classList.toggle('page-hidden', p!==page);
    const nb=document.getElementById('nav-'+p);    if(nb) nb.classList.toggle('active',p===page);
    const mb=document.getElementById('mob-nav-'+p); if(mb) mb.classList.toggle('active',p===page);
  });
  const titles={home:'All Notes',upload:'Upload Note',settings:'Settings'};
  document.getElementById('topbar-title').textContent = titles[page]||'';
  document.getElementById('view-toggle').style.display = page==='home'?'':'none';
  if(window.innerWidth<=700) closeMobileSidebar();
};

// ─── SIDEBAR ─────────────────────────────────────────────────
let sidebarCollapsed=false;
window.toggleSidebar = () => {
  if(window.innerWidth<=700) {
    document.getElementById('sidebar').classList.toggle('mobile-open');
    document.getElementById('mobile-overlay').classList.toggle('open');
  } else {
    sidebarCollapsed=!sidebarCollapsed;
    document.getElementById('sidebar').classList.toggle('collapsed',sidebarCollapsed);
  }
};
window.closeMobileSidebar = () => {
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('mobile-overlay').classList.remove('open');
};

// ─── PROFILE TRAY ─────────────────────────────────────────────
window.openProfileTray = () => {
  document.getElementById('profile-tray-overlay').classList.add('open');
  const tray = document.getElementById('profile-tray');
  tray.classList.remove('closing');
  tray.classList.add('open');
  syncTrayTheme(); syncTrayAccent();
};
window.closeProfileTray = () => {
  document.getElementById('profile-tray-overlay').classList.remove('open');
  const tray = document.getElementById('profile-tray');
  tray.classList.add('closing');
  tray.classList.remove('open');
  // After animation ends, truly hide it
  setTimeout(() => {
    tray.classList.remove('closing');
  }, 320);
};
window.syncTrayTheme = () => {
  document.querySelectorAll('.tray-theme-btn').forEach(b => b.classList.toggle('active', b.dataset.theme === settings.theme));
};
window.syncTrayAccent = () => {
  document.querySelectorAll('.tray-accent-dot').forEach(d => d.classList.toggle('active', d.dataset.accent === settings.accent));
};

// ─── OPEN IN NEW WINDOW ───────────────────────────────────────
let currentOpenNoteId = null;
window.openNoteInNewWindow = () => {
  if (!currentOpenNoteId) return;
  const note = notes.find(n => n.id === currentOpenNoteId);
  if (!note) return;
  const blob = new Blob([note.content], { type:'text/html' });
  const url  = URL.createObjectURL(blob);
  window.open(url, '_blank');
};

// ─── FOLDERS ─────────────────────────────────────────────────
window.openNewFolderModal = () => {
  renderFolderOptions('folder-parent-select',true);
  document.getElementById('folder-name-input').value='';
  document.getElementById('folder-modal').classList.add('open');
  setTimeout(()=>document.getElementById('folder-name-input').focus(),50);
};
window.closeFolderModal = () => document.getElementById('folder-modal').classList.remove('open');
window.createFolder = async () => {
  const name=document.getElementById('folder-name-input').value.trim(); if(!name) return;
  const parent=document.getElementById('folder-parent-select').value||null;
  const ref=await addDoc(foldersCol(),{name,parent});
  folders.push({id:ref.id,name,parent});
  closeFolderModal(); renderFolderTree(); renderFolderOptions('upload-folder'); showToast('Folder created!');
};

function renderFolderOptions(selectId,withRoot=false) {
  const sel=document.getElementById(selectId); if(!sel) return;
  sel.innerHTML=withRoot?'<option value="">— Root —</option>':'<option value="">— No folder —</option>';
  function add(pid,d){folders.filter(f=>(f.parent||null)===(pid||null)).forEach(f=>{const o=document.createElement('option');o.value=f.id;o.textContent='  '.repeat(d)+(d>0?'└ ':'')+f.name;sel.appendChild(o);add(f.id,d+1);});}
  add(null,0);
}

function renderFolderTree() {
  const c=document.getElementById('folder-tree'); c.innerHTML='';
  const fSVG=`<svg viewBox="0 0 24 24" width="15" height="15" style="flex-shrink:0"><path d="M3 8h18v13a1 1 0 01-1 1H4a1 1 0 01-1-1V8z" fill="var(--accent)" opacity="0.18"/><path d="M3 8l3-5h5l2 3h8" fill="none" stroke="var(--accent2)" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  const nSVG=`<svg viewBox="0 0 24 24" width="13" height="13" style="flex-shrink:0;opacity:0.6"><path d="M6 2h9l5 5v15a1 1 0 01-1 1H5a1 1 0 01-1-1V3a1 1 0 011-1z" fill="var(--text3)" opacity="0.5"/><path d="M14 2v6h6" fill="none" stroke="var(--text3)" stroke-width="1.8" stroke-linecap="round"/></svg>`;
  function build(pid,target,depth){
    folders.filter(f=>(f.parent||null)===(pid||null)).forEach(f=>{
      const ni=notes.filter(n=>n.folder===f.id);
      const hasSub=folders.some(sf=>sf.parent===f.id);
      const hasKids=ni.length>0||hasSub;
      const div=document.createElement('div'); div.className='folder-item';
      const hdr=document.createElement('div'); hdr.className='folder-header'; hdr.style.paddingLeft=(14+depth*12)+'px';
      hdr.innerHTML=`<span class="folder-arrow" style="${!hasKids?'opacity:0.2;':''}">▶</span>${fSVG}<span>${f.name}</span><span style="margin-left:auto;font-size:0.72rem;color:var(--text3)">${ni.length}</span>`;
      const kids=document.createElement('div'); kids.className='folder-children'; kids.id='fc_'+f.id;
      ni.forEach(n=>{const el=document.createElement('div');el.className='folder-note-item';el.id='sfn_'+n.id;el.style.paddingLeft=(14+depth*12+12)+'px';el.innerHTML=`${nSVG} ${n.name}`;el.onclick=()=>{openNote(n.id);if(window.innerWidth<=700)closeMobileSidebar();};kids.appendChild(el);});
      build(f.id,kids,depth+1);
      hdr.addEventListener('click',()=>{if(!hasKids)return;const a=hdr.querySelector('.folder-arrow');const o=a.classList.toggle('open');kids.classList.toggle('open',o);});
      div.appendChild(hdr); div.appendChild(kids); target.appendChild(div);
    });
  }
  build(null,c,0);
}

// ─── RENDER ──────────────────────────────────────────────────
function renderAll(){
  renderFolderTree(); renderFolderOptions('upload-folder'); renderNotes();
  document.getElementById('notes-count-meta').textContent=notes.length+' note'+(notes.length!==1?'s':'');
}

function getFolderPath(fid){if(!fid)return'';const p=[];let c=fid;while(c){const f=folders.find(x=>x.id===c);if(!f)break;p.unshift(f.name);c=f.parent;}return p.join(' / ');}

function renderNotes(){
  const container=document.getElementById('notes-container');
  const empty=document.getElementById('empty-state');
  const filtered=activeTag?notes.filter(n=>n.tags&&n.tags.includes(activeTag)):notes;
  const allTags=[...new Set(notes.flatMap(n=>n.tags||[]))];
  const bar=document.getElementById('tag-filter-bar'); bar.innerHTML='';
  if(allTags.length>0){const a=document.createElement('div');a.className='tag-chip all'+(activeTag?'':' active');a.textContent='All';a.onclick=()=>clearTagFilter();bar.appendChild(a);allTags.forEach(t=>{const ch=document.createElement('div');ch.className='tag-chip'+(activeTag===t?' active':'');ch.textContent='#'+t;ch.onclick=()=>{activeTag=t;renderNotes();};bar.appendChild(ch);});}
  const ati=document.getElementById('active-tag-indicator');ati.style.display=activeTag?'flex':'none';if(activeTag)document.getElementById('active-tag-label').textContent='#'+activeTag;
  if(filtered.length===0){container.innerHTML='';empty.style.display='';return;}
  empty.style.display='none';
  const iSVG=`<svg viewBox="0 0 24 24" width="22" height="22"><path d="M6 2h9l5 5v15a1 1 0 01-1 1H5a1 1 0 01-1-1V3a1 1 0 011-1z" fill="var(--accent)" opacity="0.18"/><path d="M14 2v6h6M8 13h8M8 17h5" fill="none" stroke="var(--accent2)" stroke-width="1.8" stroke-linecap="round"/></svg>`;
  if(currentView==='grid'){container.innerHTML='';const g=document.createElement('div');g.className='notes-grid';filtered.forEach(n=>g.appendChild(makeCard(n,iSVG)));container.appendChild(g);}
  else if(currentView==='list'){container.innerHTML='';const l=document.createElement('div');l.className='notes-list';filtered.forEach(n=>l.appendChild(makeList(n,iSVG)));container.appendChild(l);}
  else{container.innerHTML='';const by={};filtered.forEach(n=>{const k=n.folder||'__root__';if(!by[k])by[k]=[];by[k].push(n);});Object.entries(by).forEach(([fid,fn])=>{const s=document.createElement('div');s.style.marginBottom='18px';const t=document.createElement('div');t.style.cssText='font-weight:700;font-size:0.82rem;letter-spacing:0.8px;text-transform:uppercase;color:var(--text3);margin-bottom:8px;';t.textContent=fid==='__root__'?'Root':getFolderPath(fid);s.appendChild(t);const l=document.createElement('div');l.className='notes-list';fn.forEach(n=>l.appendChild(makeList(n,iSVG)));s.appendChild(l);container.appendChild(s);});}
}

function makeCard(n,svg){
  const div=document.createElement('div');div.className='note-card';
  const tags=(n.tags||[]).map(t=>`<span class="note-tag">#${t}</span>`).join('');
  const fp=getFolderPath(n.folder);
  div.innerHTML=`<div class="note-card-icon">${svg}</div><div class="note-card-name">${n.name}</div><div class="note-card-meta">${tags}</div>${fp?`<div class="note-folder-path">${fp}</div>`:''}<div class="note-card-actions"><button class="note-act-btn" onclick="event.stopPropagation();openRenameModal('${n.id}')">Rename</button><button class="note-act-btn" onclick="event.stopPropagation();downloadNote('${n.id}')">Download</button><button class="note-act-btn danger" onclick="event.stopPropagation();openDeleteModal('${n.id}')">Delete</button></div>`;
  div.addEventListener('click',()=>openNote(n.id));return div;
}

function makeList(n,svg){
  const div=document.createElement('div');div.className='note-list-item';
  const tags=(n.tags||[]).map(t=>`<span class="note-tag">#${t}</span>`).join('');
  const fp=getFolderPath(n.folder);
  div.innerHTML=`<div class="note-list-icon">${svg}</div><div><div class="note-list-name">${n.name}</div>${fp?`<div class="note-list-path">${fp}</div>`:''}<div class="note-list-tags" style="margin-top:4px">${tags}</div></div><div class="note-list-actions"><button class="note-act-btn" style="padding:5px 8px" onclick="event.stopPropagation();openRenameModal('${n.id}')">Rename</button><button class="note-act-btn" style="padding:5px 8px" onclick="event.stopPropagation();downloadNote('${n.id}')">Download</button><button class="note-act-btn danger" style="padding:5px 8px" onclick="event.stopPropagation();openDeleteModal('${n.id}')">Delete</button></div>`;
  div.addEventListener('click',()=>openNote(n.id));return div;
}

window.setView = (v)=>{currentView=v;['grid','list','tree'].forEach(x=>document.getElementById('view-'+x).classList.toggle('active',x===v));renderNotes();};
window.clearTagFilter = ()=>{activeTag=null;renderNotes();};

// ─── UPLOAD ──────────────────────────────────────────────────
function setupUploadZone(){
  const z=document.getElementById('upload-zone');
  z.addEventListener('dragover',e=>{e.preventDefault();z.classList.add('dragover');});
  z.addEventListener('dragleave',()=>z.classList.remove('dragover'));
  z.addEventListener('drop',e=>{e.preventDefault();z.classList.remove('dragover');handleFiles(e.dataTransfer.files);});
}

window.handleFiles=(files)=>{
  const html=[...files].filter(f=>f.name.endsWith('.html')||f.name.endsWith('.htm'));
  if(!html.length){showToast('Only HTML files are accepted!');return;}
  pendingFile=html[0]; uploadTags=[];
  document.getElementById('upload-file-name').textContent=pendingFile.name;
  document.getElementById('upload-name').value=pendingFile.name.replace(/\.html?$/,'');
  renderFolderOptions('upload-folder');
  document.getElementById('upload-tags-wrap').innerHTML='<input type="text" id="upload-tag-input" placeholder="Type a tag…" onkeydown="handleTagInput(event)">';
  document.getElementById('upload-form').style.display='';
  navigate('upload');
};

window.handleTagInput=(e)=>{
  if(e.key==='Enter'||e.key===','){e.preventDefault();const v=e.target.value.trim().replace(/,/g,'');if(v&&!uploadTags.includes(v)){uploadTags.push(v);renderTagPills();}e.target.value='';}
  else if(e.key==='Backspace'&&!e.target.value.length&&uploadTags.length){uploadTags.pop();renderTagPills();}
};
function renderTagPills(){
  const w=document.getElementById('upload-tags-wrap');w.innerHTML='';
  uploadTags.forEach((t,i)=>{const p=document.createElement('span');p.className='tag-pill';p.innerHTML=`${t}<span class="tag-pill-remove" onclick="removeUploadTag(${i})">×</span>`;w.appendChild(p);});
  const inp=document.createElement('input');inp.type='text';inp.id='upload-tag-input';inp.placeholder='Type a tag…';inp.setAttribute('onkeydown','handleTagInput(event)');w.appendChild(inp);
}
window.removeUploadTag=(i)=>{uploadTags.splice(i,1);renderTagPills();};

window.saveNote=async()=>{
  if(!pendingFile)return;
  const name=document.getElementById('upload-name').value.trim()||pendingFile.name;
  const folder=document.getElementById('upload-folder').value||null;
  const btn=document.getElementById('save-note-btn'); btn.disabled=true; btn.textContent='Saving…';
  const reader=new FileReader();
  reader.onload=async(e)=>{
    try{
      const data={name,folder,tags:[...uploadTags],content:e.target.result,created:new Date().toISOString()};
      const ref=await addDoc(notesCol(),data);
      notes.push({id:ref.id,...data});
      pendingFile=null;uploadTags=[];
      document.getElementById('upload-form').style.display='none';
      showToast('Note saved!'); navigate('home'); renderAll();
    }catch(err){showToast('Error: '+err.message);}
    finally{btn.disabled=false;btn.textContent='Save Note';}
  };
  reader.readAsText(pendingFile);
};
window.cancelUpload=()=>{pendingFile=null;document.getElementById('upload-form').style.display='none';navigate('home');};

// ─── NOTE VIEWER ─────────────────────────────────────────────
window.openNote=(id)=>{
  const note=notes.find(n=>n.id===id);if(!note)return;
  currentOpenNoteId = id;
  document.getElementById('note-win-title').textContent=note.name;
  document.getElementById('note-iframe').src=URL.createObjectURL(new Blob([note.content],{type:'text/html'}));
  document.getElementById('note-viewer').classList.add('open');
  const win=document.getElementById('note-window');
  if(window.innerWidth<=700){win.style.cssText='width:92vw;height:75vh;left:4vw;top:10vh;transform:none;';}
  else{win.style.cssText='width:780px;height:560px;left:50%;top:50%;transform:translate(-50%,-50%);';}
  win.classList.remove('fullscreen-win');
  document.querySelectorAll('.folder-note-item').forEach(el=>el.classList.remove('active'));
  const sfn=document.getElementById('sfn_'+id);if(sfn)sfn.classList.add('active');
};
window.closeNoteViewer=()=>{document.getElementById('note-viewer').classList.remove('open');document.getElementById('note-iframe').src='';document.querySelectorAll('.folder-note-item').forEach(el=>el.classList.remove('active'));};
window.toggleFullscreenWin=()=>{const w=document.getElementById('note-window');w.classList.toggle('fullscreen-win');if(w.classList.contains('fullscreen-win'))w.style.cssText='';};
document.getElementById('note-viewer').addEventListener('click',function(e){if(e.target===this)closeNoteViewer();});

function setupDragResize(){
  const win=document.getElementById('note-window');
  const bar=document.getElementById('note-win-titlebar');
  const rh=document.getElementById('resize-handle');
  let drag=false,resize=false,sx,sy,sw,sh,sl,st;
  bar.addEventListener('mousedown',e=>{if(win.classList.contains('fullscreen-win'))return;drag=true;sx=e.clientX;sy=e.clientY;const r=win.getBoundingClientRect();sl=r.left;st=r.top;win.style.transform='none';win.style.left=sl+'px';win.style.top=st+'px';});
  rh.addEventListener('mousedown',e=>{e.stopPropagation();resize=true;sx=e.clientX;sy=e.clientY;const r=win.getBoundingClientRect();sw=r.width;sh=r.height;sl=r.left;st=r.top;win.style.transform='none';win.style.left=sl+'px';win.style.top=st+'px';});
  document.addEventListener('mousemove',e=>{if(drag){win.style.left=(sl+e.clientX-sx)+'px';win.style.top=(st+e.clientY-sy)+'px';}else if(resize){win.style.width=Math.max(320,sw+e.clientX-sx)+'px';win.style.height=Math.max(200,sh+e.clientY-sy)+'px';}});
  document.addEventListener('mouseup',()=>{drag=false;resize=false;});
  bar.addEventListener('touchstart',e=>{if(win.classList.contains('fullscreen-win'))return;const t=e.touches[0];drag=true;sx=t.clientX;sy=t.clientY;const r=win.getBoundingClientRect();sl=r.left;st=r.top;win.style.transform='none';win.style.left=sl+'px';win.style.top=st+'px';},{passive:true});
  document.addEventListener('touchmove',e=>{if(!drag)return;const t=e.touches[0];win.style.left=(sl+t.clientX-sx)+'px';win.style.top=(st+t.clientY-sy)+'px';},{passive:true});
  document.addEventListener('touchend',()=>{drag=false;resize=false;});
}

// ─── RENAME / DELETE / DOWNLOAD ──────────────────────────────
window.openRenameModal=(id)=>{renameTarget=id;document.getElementById('rename-input').value=notes.find(n=>n.id===id).name;document.getElementById('rename-modal').classList.add('open');setTimeout(()=>document.getElementById('rename-input').focus(),50);};
window.closeRenameModal=()=>document.getElementById('rename-modal').classList.remove('open');
window.confirmRename=async()=>{
  const v=document.getElementById('rename-input').value.trim();if(!v)return;
  await updateDoc(doc(db,'users',currentUser.uid,'notes',renameTarget),{name:v});
  notes.find(n=>n.id===renameTarget).name=v;
  closeRenameModal();renderAll();showToast('Note renamed!');
};

window.openDeleteModal=(id)=>{deleteTarget=id;document.getElementById('delete-note-name').textContent=notes.find(n=>n.id===id).name;document.getElementById('delete-modal').classList.add('open');};
window.closeDeleteModal=()=>document.getElementById('delete-modal').classList.remove('open');
window.confirmDelete=async()=>{
  await deleteDoc(doc(db,'users',currentUser.uid,'notes',deleteTarget));
  notes=notes.filter(n=>n.id!==deleteTarget);
  closeDeleteModal();renderAll();showToast('Note deleted!');
};

window.downloadNote=(id)=>{const n=notes.find(x=>x.id===id);if(!n)return;const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([n.content],{type:'text/html'}));a.download=n.name+'.html';a.click();showToast('Downloading…');};

// ─── TOAST ───────────────────────────────────────────────────
let toastTimer;
window.showToast=(msg)=>{const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),2400);};

// ─── PWA INSTALL PROMPT ───────────────────────────────────────
let deferredInstallPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredInstallPrompt = e;
  // Show install button in tray if available
  const installBtn = document.getElementById('tray-install-btn');
  if (installBtn) installBtn.style.display = 'flex';
});
window.installPWA = async () => {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  const result = await deferredInstallPrompt.userChoice;
  if (result.outcome === 'accepted') showToast('NoteZ added to home screen!');
  deferredInstallPrompt = null;
  const installBtn = document.getElementById('tray-install-btn');
  if (installBtn) installBtn.style.display = 'none';
};

document.addEventListener('DOMContentLoaded',()=>{
  setupDragResize(); setupUploadZone();
  document.getElementById('login-password').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
  document.getElementById('login-email').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
  document.getElementById('rename-input').addEventListener('keydown',e=>{if(e.key==='Enter')confirmRename();});
  document.getElementById('folder-name-input').addEventListener('keydown',e=>{if(e.key==='Enter')createFolder();});
  ['folder-modal','rename-modal','delete-modal'].forEach(id=>{document.getElementById(id).addEventListener('click',function(e){if(e.target===this)this.classList.remove('open');});});
});
</script>
</body>
</html>
