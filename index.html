<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>NoteZ</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600&family=Nunito:wght@300;400;500;600;700&family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,600;1,9..144,400&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME TOKENS (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root, [data-theme="blue-light"] {
  --bg:#f0f4ff;--bg2:#e4ecff;--surface:#fff;--surface2:#f5f8ff;
  --border:#c8d8f8;--border2:#b0c4f0;--text:#0f1c3f;--text2:#4a5880;--text3:#8a9abf;
  --accent:#2563eb;--accent2:#1d4ed8;--accent-bg:rgba(37,99,235,.1);
  --accent-glow:0 0 20px rgba(37,99,235,.2);
  --shadow:0 2px 16px rgba(37,99,235,.08);--shadow-lg:0 8px 40px rgba(37,99,235,.15);
  --shadow-card:0 4px 20px rgba(37,99,235,.1),0 1px 4px rgba(0,0,0,.05);
}
[data-theme="blue-dark"] {
  --bg:#080e1f;--bg2:#0e1728;--surface:#111c35;--surface2:#162040;
  --border:#1e2e55;--border2:#253665;--text:#e8eeff;--text2:#8a9abf;--text3:#4a5880;
  --accent:#4f8cff;--accent2:#6ba3ff;--accent-bg:rgba(79,140,255,.12);
  --accent-glow:0 0 24px rgba(79,140,255,.3);
  --shadow:0 2px 16px rgba(0,0,0,.4);--shadow-lg:0 8px 40px rgba(0,0,0,.6);
  --shadow-card:0 4px 24px rgba(0,0,0,.4),0 0 0 1px rgba(79,140,255,.08);
}
[data-theme="yellow-light"] {
  --bg:#fffbeb;--bg2:#fef3c7;--surface:#fff;--surface2:#fffdf5;
  --border:#fde68a;--border2:#fbbf24;--text:#2d1e00;--text2:#78530a;--text3:#b07830;
  --accent:#d97706;--accent2:#b45309;--accent-bg:rgba(217,119,6,.1);
  --accent-glow:0 0 20px rgba(217,119,6,.2);
  --shadow:0 2px 16px rgba(217,119,6,.08);--shadow-lg:0 8px 40px rgba(217,119,6,.15);
  --shadow-card:0 4px 20px rgba(217,119,6,.1),0 1px 4px rgba(0,0,0,.05);
}
[data-theme="yellow-dark"] {
  --bg:#120e00;--bg2:#1c1500;--surface:#221a00;--surface2:#2a2000;
  --border:#3d2e00;--border2:#5a4400;--text:#fff8e0;--text2:#c4943a;--text3:#7a5820;
  --accent:#fbbf24;--accent2:#fcd34d;--accent-bg:rgba(251,191,36,.12);
  --accent-glow:0 0 24px rgba(251,191,36,.3);
  --shadow:0 2px 16px rgba(0,0,0,.4);--shadow-lg:0 8px 40px rgba(0,0,0,.6);
  --shadow-card:0 4px 24px rgba(0,0,0,.4),0 0 0 1px rgba(251,191,36,.08);
}
[data-theme="green-light"] {
  --bg:#f0faf4;--bg2:#dcf5e7;--surface:#fff;--surface2:#f4fbf6;
  --border:#a7e3bc;--border2:#6ecf95;--text:#0a2016;--text2:#2d6b48;--text3:#6aab84;
  --accent:#16a34a;--accent2:#15803d;--accent-bg:rgba(22,163,74,.1);
  --accent-glow:0 0 20px rgba(22,163,74,.2);
  --shadow:0 2px 16px rgba(22,163,74,.08);--shadow-lg:0 8px 40px rgba(22,163,74,.15);
  --shadow-card:0 4px 20px rgba(22,163,74,.1),0 1px 4px rgba(0,0,0,.05);
}
[data-theme="green-dark"] {
  --bg:#030f08;--bg2:#061410;--surface:#091a10;--surface2:#0d2016;
  --border:#133320;--border2:#1a4a2e;--text:#e0f5ea;--text2:#5abf80;--text3:#2d6b48;
  --accent:#34d468;--accent2:#4ade80;--accent-bg:rgba(52,212,104,.12);
  --accent-glow:0 0 24px rgba(52,212,104,.3);
  --shadow:0 2px 16px rgba(0,0,0,.4);--shadow-lg:0 8px 40px rgba(0,0,0,.6);
  --shadow-card:0 4px 24px rgba(0,0,0,.4),0 0 0 1px rgba(52,212,104,.08);
}

/* â”€â”€ FONT VARS â”€â”€ */
[data-font="jakarta"] { --font:'Plus Jakarta Sans',sans-serif; }
[data-font="dm"]      { --font:'DM Sans',sans-serif; }
[data-font="nunito"]  { --font:'Nunito',sans-serif; }
[data-font="fraunces"]{ --font:'Fraunces',serif; }
[data-font="mono"]    { --font:'IBM Plex Mono',monospace; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BASE (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);
  font-family:var(--font,'Plus Jakarta Sans',sans-serif);font-size:14px;
  -webkit-tap-highlight-color:transparent;transition:background .3s,color .3s;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH SCREEN (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#auth-screen {
  position:fixed;inset:0;z-index:9000;
  background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  padding:20px;
  transition:opacity .3s;
}
#auth-screen.hide{opacity:0;pointer-events:none;}

.auth-card {
  width:100%;max-width:400px;
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:24px;
  padding:32px 28px;
  box-shadow:var(--shadow-lg);
  display:flex;flex-direction:column;gap:20px;
}
.auth-logo {
  text-align:center;
  font-size:26px;font-weight:800;color:var(--accent);letter-spacing:-.04em;
}
.auth-logo span{color:var(--text3);font-weight:400;font-size:13px;display:block;margin-top:2px;}
.auth-tabs{display:flex;background:var(--bg2);border-radius:12px;padding:3px;gap:3px;}
.auth-tab{
  flex:1;padding:9px;border:none;background:none;border-radius:10px;
  font-family:inherit;font-size:13px;font-weight:600;color:var(--text3);cursor:pointer;transition:all .18s;
}
.auth-tab.on{background:var(--surface);color:var(--accent);box-shadow:var(--shadow);}
.auth-fields{display:flex;flex-direction:column;gap:10px;}
.auth-input{
  width:100%;padding:13px 15px;border:1.5px solid var(--border);border-radius:12px;
  background:var(--bg2);color:var(--text);font-family:inherit;font-size:16px;
  outline:none;-webkit-appearance:none;transition:border-color .18s,box-shadow .18s;
}
.auth-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-bg);}
.auth-input::placeholder{color:var(--text3);}
.auth-btn{
  width:100%;padding:13px;border:none;border-radius:12px;
  background:var(--accent);color:#fff;font-family:inherit;
  font-size:15px;font-weight:700;cursor:pointer;
  box-shadow:var(--accent-glow);transition:all .18s;
}
.auth-btn:active{transform:scale(.97);}
.auth-divider{text-align:center;color:var(--text3);font-size:12px;position:relative;}
.auth-divider::before,.auth-divider::after{content:'';position:absolute;top:50%;width:42%;height:1px;background:var(--border);}
.auth-divider::before{left:0;}.auth-divider::after{right:0;}
.demo-bypass-btn{
  width:100%;padding:11px;border:1.5px dashed var(--border2);border-radius:12px;
  background:none;color:var(--text2);font-family:inherit;font-size:13px;
  font-weight:600;cursor:pointer;transition:all .18s;display:flex;align-items:center;justify-content:center;gap:7px;
}
.demo-bypass-btn:hover,.demo-bypass-btn:active{background:var(--accent-bg);border-color:var(--accent);color:var(--accent);}
.auth-error{color:#ef4444;font-size:12px;text-align:center;min-height:16px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN APP SHELL (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{display:flex;flex-direction:column;height:100dvh;overflow:hidden;opacity:0;transition:opacity .3s;}
#app.visible{opacity:1;}

/* â”€â”€ TOPBAR â”€â”€ */
#topbar{
  height:52px;background:var(--surface);border-bottom:1px solid var(--border);
  box-shadow:var(--shadow);display:flex;align-items:center;
  padding:0 12px;gap:8px;flex-shrink:0;z-index:10;transition:background .3s,border-color .3s;
}
.tib{
  width:36px;height:36px;display:flex;align-items:center;justify-content:center;
  border:none;background:none;color:var(--text2);cursor:pointer;
  border-radius:10px;flex-shrink:0;transition:background .18s,color .18s;
}
.tib:hover{background:var(--accent-bg);color:var(--accent);}
.tib:active{transform:scale(.93);}

/* Avatar button in topbar (desktop) */
#topbar-avatar{
  width:32px;height:32px;border-radius:50%;border:2px solid var(--accent);
  background:var(--accent-bg);display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:700;color:var(--accent);cursor:pointer;
  transition:all .18s;flex-shrink:0;overflow:hidden;
}
#topbar-avatar:hover{box-shadow:var(--accent-glow);}
#topbar-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%;}

#breadcrumb{
  flex:1;min-width:0;font-size:13px;font-weight:500;color:var(--text2);
  display:flex;align-items:center;gap:5px;overflow:hidden;
}
.bc-item{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;transition:color .15s;}
.bc-item:hover{color:var(--accent);}
.bc-cur{color:var(--text);font-weight:600;}
.bc-sep{color:var(--text3);flex-shrink:0;}

#vtabs{
  display:flex;background:var(--bg2);border:1px solid var(--border);
  border-radius:20px;padding:3px;gap:2px;flex-shrink:0;transition:background .3s,border-color .3s;
}
.vtab{
  padding:4px 12px;border-radius:20px;border:none;background:none;color:var(--text3);
  font-family:inherit;font-size:11.5px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;
}
.vtab.on{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.15);}

/* â”€â”€ CONTENT â”€â”€ */
#content{flex:1;overflow:hidden;position:relative;}
.view{position:absolute;inset:0;display:none;opacity:0;transition:opacity .22s ease;}
.view.on{display:block;opacity:1;}

/* Content wallpaper */
#content.has-wallpaper { background-size:cover;background-position:center;background-repeat:no-repeat; }

#grid-view{overflow-y:auto;overflow-x:hidden;padding:16px 14px calc(72px + env(safe-area-inset-bottom));-webkit-overflow-scrolling:touch;}
#cards-wrap{display:flex;flex-direction:column;gap:12px;}
#focus-view{}
#focus-frame{width:100%;height:100%;border:none;background:#fff;}

/* Empty */
#empty-view{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:18px;padding:32px;text-align:center;pointer-events:none;
}
.empty-icon{width:72px;height:72px;border-radius:24px;background:var(--accent-bg);display:flex;align-items:center;justify-content:center;font-size:32px;}
.empty-title{font-size:20px;font-weight:700;color:var(--text);}
.empty-sub{font-size:13px;color:var(--text3);max-width:240px;line-height:1.7;}

/* â”€â”€ NOTE CARD â”€â”€ */
.ncard{
  width:100%;height:300px;background:var(--surface);border:1px solid var(--border);
  border-radius:16px;display:flex;flex-direction:column;overflow:hidden;position:relative;
  box-shadow:var(--shadow-card);transition:box-shadow .25s,border-color .25s,transform .18s;
}
.ncard:hover{box-shadow:var(--shadow-lg);border-color:var(--accent);transform:translateY(-1px);}
.ncard.drag-src{opacity:.4;transform:scale(.98);}

.card-hdr{
  display:flex;align-items:center;gap:8px;padding:10px 12px;
  background:var(--surface2);border-bottom:1px solid var(--border);
  flex-shrink:0;cursor:grab;user-select:none;transition:background .3s;
}
.card-hdr:active{cursor:grabbing;}
.card-accent-bar{width:3px;height:16px;border-radius:2px;background:var(--accent);flex-shrink:0;transition:background .3s;}
.card-name{flex:1;min-width:0;font-size:12px;font-weight:600;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.card-badge{font-size:9.5px;font-weight:700;letter-spacing:.04em;padding:2px 7px;border-radius:20px;background:var(--accent-bg);color:var(--accent);flex-shrink:0;transition:all .3s;}
.card-tools{display:flex;gap:1px;flex-shrink:0;}
.card-tools select{font-size:10px;background:var(--bg2);border:1px solid var(--border);color:var(--text2);border-radius:6px;padding:2px 4px;font-family:inherit;cursor:pointer;transition:background .3s,border-color .3s;}
.card-body{flex:1;overflow:hidden;}
.card-iframe{width:100%;height:100%;border:none;display:block;background:#fff;}
.resize-k{position:absolute;right:4px;bottom:4px;width:18px;height:18px;cursor:nwse-resize;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s;z-index:5;color:var(--text3);border-radius:4px;}
.ncard:hover .resize-k{opacity:1;}

/* â”€â”€ ICON BTN â”€â”€ */
.ib{width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:8px;border:none;background:none;color:var(--text3);cursor:pointer;transition:background .15s,color .15s;flex-shrink:0;}
.ib:hover{background:var(--accent-bg);color:var(--accent);}
.ib:active{transform:scale(.9);}
.ib.danger:hover{background:rgba(239,68,68,.12);color:#ef4444;}
.ib svg{pointer-events:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE BOTTOM BAR (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#bot-bar{
  position:fixed;bottom:0;left:0;right:0;
  height:calc(60px + env(safe-area-inset-bottom));
  padding-bottom:env(safe-area-inset-bottom);
  background:var(--surface);border-top:1px solid var(--border);
  box-shadow:0 -4px 20px rgba(0,0,0,.08);
  z-index:500;display:flex;align-items:center;
  padding-left:8px;padding-right:8px;
  transition:background .3s,border-color .3s;
}
.bbn{flex:1;height:100%;display:flex;align-items:center;justify-content:center;border:none;background:none;color:var(--text3);cursor:pointer;border-radius:12px;transition:color .2s,background .2s;}
.bbn:active{background:var(--accent-bg);}
.bbn.on{color:var(--accent);}
.bbn svg{transition:transform .2s;}
.bbn.on svg{transform:scale(1.12);}

/* Profile avatar in bottom bar */
#bb-profile{flex:1;height:100%;display:flex;align-items:center;justify-content:center;border:none;background:none;cursor:pointer;border-radius:12px;transition:background .2s;}
#bb-profile:active{background:var(--accent-bg);}
#bb-profile-avatar{width:28px;height:28px;border-radius:50%;border:2px solid var(--border2);background:var(--accent-bg);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--accent);overflow:hidden;transition:border-color .2s;}
#bb-profile.on #bb-profile-avatar{border-color:var(--accent);}
#bb-profile-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%;}

#fab{
  width:50px;height:50px;border-radius:16px;
  background:var(--accent);border:none;color:#fff;
  display:flex;align-items:center;justify-content:center;
  box-shadow:var(--accent-glow),0 4px 12px rgba(0,0,0,.2);
  cursor:pointer;flex-shrink:0;
  transition:transform .2s cubic-bezier(.34,1.56,.64,1),background .3s,box-shadow .3s;
}
#fab:active{transform:scale(.9);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR â€” FULL SCREEN (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sb-back{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:600;backdrop-filter:blur(4px);opacity:0;transition:opacity .25s;}
#sb-back.on{display:block;opacity:1;}

#sidebar{
  position:fixed;inset:0;background:var(--surface);z-index:700;
  display:flex;flex-direction:column;
  transform:translateX(-100%);transition:transform .3s cubic-bezier(.4,0,.2,1);
  will-change:transform;
}
#sidebar.on{transform:translateX(0);}

#sb-top{
  height:60px;display:flex;align-items:center;padding:0 16px;gap:10px;
  border-bottom:1px solid var(--border);flex-shrink:0;background:var(--surface);
}
.sb-logo{flex:1;font-size:20px;font-weight:800;color:var(--accent);letter-spacing:-.03em;transition:color .3s;}
.sb-logo em{font-style:normal;color:var(--text3);font-size:13px;font-weight:400;margin-left:6px;}

#tree-wrap{flex:1;overflow-y:auto;padding:10px 8px;-webkit-overflow-scrolling:touch;}
.tnode{user-select:none;}
.trow{
  display:flex;align-items:center;min-height:44px;padding:6px 10px 6px 0;
  border-radius:12px;cursor:pointer;transition:background .15s;gap:4px;margin:2px 0;
}
.trow:hover{background:var(--bg2);}
.trow.on{background:var(--accent-bg);}
.trow.on .rname{color:var(--accent);font-weight:600;}
.trow.dov{outline:2px solid var(--accent);outline-offset:-2px;border-radius:12px;}
.rtog{width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:6px;flex-shrink:0;color:var(--text3);transition:transform .18s,color .15s;}
.rtog.op{transform:rotate(90deg);}
.rtog.lf{opacity:0;pointer-events:none;}
.rico{font-size:16px;flex-shrink:0;margin-right:2px;}
.rname{flex:1;font-size:14px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;transition:color .15s;}
.rname-inp{flex:1;font-size:14px;font-family:inherit;background:none;border:none;outline:none;color:var(--text);min-width:0;}
.ract{display:flex;gap:2px;flex-shrink:0;}
.tchildren{overflow:hidden;}

#sb-bot{
  padding:14px 16px calc(14px + env(safe-area-inset-bottom));
  border-top:1px solid var(--border);flex-shrink:0;display:flex;gap:10px;background:var(--surface);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILE / ACCOUNT SETTINGS PANEL (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#profile-back{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:800;backdrop-filter:blur(4px);opacity:0;transition:opacity .25s;}
#profile-back.on{display:block;opacity:1;}

#profile-panel{
  position:fixed;bottom:0;left:0;right:0;
  background:var(--surface);
  border-radius:24px 24px 0 0;
  border-top:1px solid var(--border);
  z-index:900;display:flex;flex-direction:column;
  transform:translateY(110%);transition:transform .32s cubic-bezier(.4,0,.2,1);
  box-shadow:var(--shadow-lg);max-height:90dvh;overflow-y:auto;
}
#profile-panel.on{transform:translateY(0);}

.pp-pill{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:14px auto 0;flex-shrink:0;}
.pp-header{padding:16px 20px 0;display:flex;align-items:center;gap:16px;}
.pp-avatar-wrap{position:relative;flex-shrink:0;}
.pp-avatar{
  width:72px;height:72px;border-radius:50%;border:3px solid var(--accent);
  background:var(--accent-bg);display:flex;align-items:center;justify-content:center;
  font-size:28px;font-weight:700;color:var(--accent);overflow:hidden;cursor:pointer;
  transition:box-shadow .18s;
}
.pp-avatar:hover{box-shadow:var(--accent-glow);}
.pp-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.pp-avatar-edit{
  position:absolute;bottom:0;right:0;width:22px;height:22px;
  background:var(--accent);border-radius:50%;border:2px solid var(--surface);
  display:flex;align-items:center;justify-content:center;cursor:pointer;
}
.pp-info{flex:1;min-width:0;}
.pp-name{font-size:18px;font-weight:700;color:var(--text);}
.pp-email{font-size:12px;color:var(--text3);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pp-badge{display:inline-flex;align-items:center;gap:4px;margin-top:6px;font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;background:var(--accent-bg);color:var(--accent);}

.pp-section{padding:16px 20px;border-bottom:1px solid var(--border);}
.pp-section:last-of-type{border-bottom:none;}
.pp-label{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px;}

.pp-field{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;}
.pp-field:last-child{margin-bottom:0;}
.pp-fl{font-size:11px;font-weight:600;color:var(--text2);}
.pp-input{
  width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:12px;
  background:var(--bg2);color:var(--text);font-family:inherit;font-size:16px;
  outline:none;-webkit-appearance:none;transition:border-color .18s,box-shadow .18s;
}
.pp-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-bg);}

/* Theme grid inside profile */
.theme-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.theme-swatch{display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px 6px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:border-color .18s,background .18s;background:var(--bg2);}
.theme-swatch.active{border-color:var(--accent);background:var(--accent-bg);}
.swatch-dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;}
.swatch-name{font-size:10px;font-weight:600;color:var(--text2);text-align:center;}

/* Font list */
.font-list{display:flex;flex-direction:column;gap:6px;}
.font-opt{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;cursor:pointer;background:var(--bg2);border:2px solid transparent;transition:border-color .15s,background .15s;}
.font-opt.active{border-color:var(--accent);background:var(--accent-bg);}
.font-preview{font-size:15px;color:var(--text);flex:1;}
.font-check{color:var(--accent);opacity:0;transition:opacity .15s;flex-shrink:0;}
.font-opt.active .font-check{opacity:1;}

/* Danger zone */
.pp-logout-btn{width:100%;padding:12px;border:1.5px solid rgba(239,68,68,.3);border-radius:12px;background:rgba(239,68,68,.06);color:#ef4444;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:all .18s;display:flex;align-items:center;justify-content:center;gap:8px;}
.pp-logout-btn:active{background:rgba(239,68,68,.15);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE WALLPAPER PICKER (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#wp-back{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:800;backdrop-filter:blur(4px);opacity:0;transition:opacity .25s;}
#wp-back.on{display:block;opacity:1;}

#wp-panel{
  position:fixed;bottom:0;left:0;right:0;
  background:var(--surface);border-radius:24px 24px 0 0;
  border-top:1px solid var(--border);z-index:900;
  display:flex;flex-direction:column;
  transform:translateY(110%);transition:transform .32s cubic-bezier(.4,0,.2,1);
  box-shadow:var(--shadow-lg);max-height:80dvh;overflow-y:auto;
}
#wp-panel.on{transform:translateY(0);}
.wp-pill{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:14px auto 0;flex-shrink:0;}
.wp-title{padding:14px 20px 8px;font-size:17px;font-weight:700;color:var(--text);}
.wp-subtitle{padding:0 20px 14px;font-size:12px;color:var(--text3);}

.wp-section{padding:0 20px 16px;}
.wp-section-label{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;}

/* Gradient wallpapers */
.wp-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:4px;}
.wp-swatch{
  aspect-ratio:16/9;border-radius:10px;cursor:pointer;
  border:2px solid transparent;transition:transform .15s,border-color .15s;
  position:relative;overflow:hidden;
}
.wp-swatch:hover{transform:scale(1.05);}
.wp-swatch.active{border-color:var(--accent);}
.wp-swatch .wp-check{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.35);opacity:0;transition:opacity .15s;
  font-size:18px;
}
.wp-swatch.active .wp-check{opacity:1;}

/* None option */
.wp-none{
  display:flex;align-items:center;justify-content:center;gap:6px;
  padding:11px;border-radius:10px;cursor:pointer;
  border:2px dashed var(--border2);color:var(--text3);font-size:13px;font-weight:600;
  transition:all .15s;margin-bottom:12px;
}
.wp-none:hover,.wp-none.active{border-color:var(--accent);color:var(--accent);background:var(--accent-bg);}

/* Custom URL */
.wp-url-row{display:flex;gap:8px;}
.wp-url-inp{
  flex:1;padding:10px 13px;border:1.5px solid var(--border);border-radius:10px;
  background:var(--bg2);color:var(--text);font-family:inherit;font-size:15px;
  outline:none;-webkit-appearance:none;transition:border-color .18s;
}
.wp-url-inp:focus{border-color:var(--accent);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);display:none;align-items:flex-end;justify-content:center;z-index:1000;opacity:0;transition:opacity .22s;}
.modal-back.on{display:flex;opacity:1;}
.modal{background:var(--surface);border-radius:20px 20px 0 0;border:1px solid var(--border);padding:14px 20px calc(20px + env(safe-area-inset-bottom));width:100%;max-width:540px;box-shadow:var(--shadow-lg);display:flex;flex-direction:column;gap:14px;max-height:92dvh;overflow-y:auto;transform:translateY(20px);transition:transform .25s cubic-bezier(.4,0,.2,1);}
.modal-back.on .modal{transform:translateY(0);}
.modal-pill{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 4px;}
.modal-title{font-size:18px;font-weight:700;color:var(--text);}
.ff{display:flex;flex-direction:column;gap:6px;}
.fl{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;}
.fi,.fsl,.fta{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:12px;background:var(--bg2);color:var(--text);font-family:inherit;font-size:16px;outline:none;-webkit-appearance:none;appearance:none;transition:border-color .18s,box-shadow .18s,background .3s;}
.fi:focus,.fta:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-bg);}
.fta{font-family:'IBM Plex Mono',monospace;font-size:12.5px;resize:none;min-height:110px;line-height:1.65;}
.fsl{cursor:pointer;}
.mac{display:flex;gap:8px;}
.mac .btn{flex:1;justify-content:center;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{display:inline-flex;align-items:center;gap:7px;padding:11px 18px;border-radius:12px;border:1.5px solid var(--border);background:var(--surface2);color:var(--text2);font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:all .18s;white-space:nowrap;}
.btn:active{transform:scale(.96);}
.btn.pri{background:var(--accent);color:#fff;border-color:transparent;box-shadow:var(--accent-glow);}
.btn.pri:hover{background:var(--accent2);}
.btn.gh{border-color:transparent;background:none;color:var(--text3);}
.btn.gh:hover{background:var(--bg2);color:var(--text);}
.btn.sm{padding:8px 12px;font-size:12px;border-radius:10px;}
.btn.full{width:100%;justify-content:center;}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:calc(68px + env(safe-area-inset-bottom));left:50%;transform:translateX(-50%) translateY(8px);padding:9px 18px;background:var(--text);color:var(--surface);border-radius:20px;font-size:12.5px;font-weight:600;box-shadow:var(--shadow-lg);opacity:0;transition:all .22s;pointer-events:none;z-index:2000;white-space:nowrap;}
#toast.on{opacity:1;transform:translateX(-50%) translateY(0);}

/* â”€â”€ DROP ZONE â”€â”€ */
#dropzone{display:none;position:fixed;inset:0;background:var(--accent-bg);border:3px dashed var(--accent);align-items:center;justify-content:center;z-index:1500;pointer-events:none;}
#dropzone.on{display:flex;}
.dz-lbl{font-size:18px;font-weight:700;color:var(--accent);background:var(--surface);padding:18px 32px;border-radius:16px;box-shadow:var(--shadow-lg);border:1.5px solid var(--accent);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESKTOP (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(min-width:641px){
  #app{flex-direction:row;}
  #sidebar{position:static!important;width:268px;flex-shrink:0;transform:none!important;box-shadow:none!important;border-right:1px solid var(--border);transition:width .25s ease,border-color .3s;}
  #sidebar.dk-col{width:0;overflow:hidden;border-right-color:transparent;}
  #sb-back{display:none!important;}
  #mob-btn{display:none;}
  #bot-bar{display:none!important;}
  #dk-toggle,#dk-add,#topbar-avatar{display:flex!important;}
  #main{flex:1;min-width:0;display:flex;flex-direction:column;height:100dvh;}
  #topbar{padding:0 16px;}
  #grid-view{padding:24px 22px 40px;}
  #cards-wrap{flex-direction:row;flex-wrap:wrap;gap:16px;align-items:flex-start;}
  .ncard{width:auto;height:auto;}
  .ncard.sz-s{width:260px;height:210px;}
  .ncard.sz-m{width:380px;height:300px;}
  .ncard.sz-l{width:540px;height:370px;}
  .ncard.sz-xl{width:740px;height:480px;}
  .ncard.sz-fw{width:100%;height:440px;}
  .modal-back{align-items:center;}
  .modal{border-radius:20px;padding:26px;max-height:86dvh;}
  .modal-pill{display:none;}
  .mac .btn{flex:none;}
  .mac{justify-content:flex-end;}
  #profile-panel{border-radius:20px;bottom:auto;top:50%;right:20px;left:auto;width:380px;transform:translateY(calc(-50% + 20px));opacity:0;transition:transform .28s cubic-bezier(.4,0,.2,1),opacity .28s;}
  #profile-panel.on{transform:translateY(-50%);opacity:1;}
  #wp-panel{border-radius:20px;bottom:auto;top:50%;right:20px;left:auto;width:400px;transform:translateY(calc(-50% + 20px));opacity:0;transition:transform .28s,opacity .28s;}
  #wp-panel.on{transform:translateY(-50%);opacity:1;}
  #toast{bottom:24px;left:auto;right:24px;transform:translateY(8px);}
  #toast.on{transform:translateY(0);}
}
@media(min-width:641px) and (max-width:960px){
  #sidebar{width:224px;}
  .ncard.sz-l,.ncard.sz-xl{width:100%;}
}
</style>
</head>
<body data-theme="blue-light" data-font="jakarta">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH SCREEN (ONLY NAME CHANGED TO NoteZ)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">
      NoteZ
      <span>your HTML-native workspace</span>
    </div>

    <div class="auth-tabs">
      <button class="auth-tab on" onclick="switchAuthTab('login',this)">Sign In</button>
      <button class="auth-tab" onclick="switchAuthTab('signup',this)">Sign Up</button>
    </div>

    <div id="auth-login-fields" class="auth-fields">
      <input class="auth-input" id="login-email" type="email" placeholder="Email address" autocomplete="email">
      <input class="auth-input" id="login-pass" type="password" placeholder="Password" autocomplete="current-password">
    </div>
    <div id="auth-signup-fields" class="auth-fields" style="display:none">
      <input class="auth-input" id="signup-name" type="text" placeholder="Your name" autocomplete="name">
      <input class="auth-input" id="signup-email" type="email" placeholder="Email address" autocomplete="email">
      <input class="auth-input" id="signup-pass" type="password" placeholder="Password (min 6 chars)" autocomplete="new-password">
    </div>

    <div id="auth-error" class="auth-error"></div>

    <button class="auth-btn" id="auth-submit-btn" onclick="authSubmit()">Sign In</button>

    <div class="auth-divider">or</div>

    <button class="demo-bypass-btn" onclick="demoBypass()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      Continue in Demo Mode (no account needed)
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">

  <div id="sb-back" onclick="closeSB()"></div>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div id="sb-top">
      <span class="sb-logo">NoteZ <em>workspace</em></span>
      <button class="ib" onclick="openWallpaperPicker()" title="Page wallpaper" id="wp-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      </button>
      <button class="ib" onclick="closeSB()" title="Close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div id="tree-wrap"><div id="tree"></div></div>
    <div id="sb-bot">
      <button class="btn sm full pri" onclick="openPgModal(null)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        New Page
      </button>
      <button class="btn sm" onclick="pickFiles()" title="Upload .html">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </button>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main">
    <div id="topbar">
      <button class="tib" id="mob-btn" onclick="openSB()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <button class="tib" id="dk-toggle" style="display:none" onclick="dkToggle()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/></svg>
      </button>
      <div id="breadcrumb"></div>
      <div id="vtabs">
        <button class="vtab on" data-v="grid" onclick="setView('grid')">Grid</button>
        <button class="vtab" data-v="focus" onclick="setView('focus')">Focus</button>
      </div>
      <button class="tib" onclick="openWallpaperPicker()" title="Set wallpaper" id="dk-wp-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      </button>
      <button class="btn sm pri" id="dk-add" style="display:none" onclick="openNoteModal()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Note
      </button>
      <!-- Desktop avatar -->
      <div id="topbar-avatar" style="display:none" onclick="openProfile()" title="Profile & Settings"></div>
    </div>

    <div id="content">
      <div class="view on" id="empty-view">
        <div class="empty-icon">ğŸ“„</div>
        <div class="empty-title">No page open</div>
        <div class="empty-sub">Open the sidebar to create your first page</div>
      </div>
      <div class="view" id="grid-view"><div id="cards-wrap"></div></div>
      <div class="view" id="focus-view">
        <iframe id="focus-frame" src="about:blank" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-presentation allow-top-navigation"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- MOBILE BOTTOM BAR -->
<div id="bot-bar">
  <button class="bbn" id="bb-pages" onclick="openSB()">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
  <button class="bbn" id="bb-grid" onclick="setView('grid')">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>
  </button>
  <button id="fab" onclick="openNoteModal()">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </button>
  <button class="bbn" id="bb-focus" onclick="setView('focus')">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></svg>
  </button>
  <!-- Profile button in bottom bar -->
  <button id="bb-profile" onclick="openProfile()">
    <div id="bb-profile-avatar"></div>
  </button>
</div>

<!-- â•â• PROFILE / ACCOUNT SETTINGS PANEL â•â• -->
<div id="profile-back" onclick="closeProfile()"></div>
<div id="profile-panel">
  <div class="pp-pill"></div>

  <!-- Header with avatar + info -->
  <div class="pp-header">
    <div class="pp-avatar-wrap">
      <div class="pp-avatar" id="pp-avatar-display" onclick="triggerAvatarUpload()"></div>
      <div class="pp-avatar-edit" onclick="triggerAvatarUpload()">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      </div>
    </div>
    <div class="pp-info">
      <div class="pp-name" id="pp-display-name">Guest</div>
      <div class="pp-email" id="pp-display-email">demo@notez.app</div>
      <div class="pp-badge" id="pp-display-badge">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
        Demo Mode
      </div>
    </div>
  </div>

  <!-- Edit profile -->
  <div class="pp-section">
    <div class="pp-label">Profile</div>
    <div class="pp-field">
      <label class="pp-fl">Display Name</label>
      <input class="pp-input" id="pp-name-input" type="text" placeholder="Your name" autocomplete="off">
    </div>
    <div class="pp-field">
      <label class="pp-fl">Bio</label>
      <input class="pp-input" id="pp-bio-input" type="text" placeholder="Short bio (optional)">
    </div>
    <button class="btn pri full" onclick="saveProfile()" style="margin-top:4px">Save Profile</button>
  </div>

  <!-- Theme -->
  <div class="pp-section">
    <div class="pp-label">Theme</div>
    <div class="theme-grid" id="pp-theme-grid">
      <div class="theme-swatch active" data-theme="blue-light" onclick="setTheme('blue-light',this)"><div class="swatch-dot" style="background:linear-gradient(135deg,#2563eb,#60a5fa)">â˜€ï¸</div><div class="swatch-name">Blue Light</div></div>
      <div class="theme-swatch" data-theme="blue-dark" onclick="setTheme('blue-dark',this)"><div class="swatch-dot" style="background:linear-gradient(135deg,#0e1728,#4f8cff)">ğŸŒ™</div><div class="swatch-name">Blue Dark</div></div>
      <div class="theme-swatch" data-theme="yellow-light" onclick="setTheme('yellow-light',this)"><div class="swatch-dot" style="background:linear-gradient(135deg,#d97706,#fbbf24)">â˜€ï¸</div><div class="swatch-name">Amber Light</div></div>
      <div class="theme-swatch" data-theme="yellow-dark" onclick="setTheme('yellow-dark',this)"><div class="swatch-dot" style="background:linear-gradient(135deg,#221a00,#fbbf24)">ğŸŒ™</div><div class="swatch-name">Amber Dark</div></div>
      <div class="theme-swatch" data-theme="green-light" onclick="setTheme('green-light',this)"><div class="swatch-dot" style="background:linear-gradient(135deg,#16a34a,#4ade80)">â˜€ï¸</div><div class="swatch-name">Green Light</div></div>
      <div class="theme-swatch" data-theme="green-dark" onclick="setTheme('green-dark',this)"><div class="swatch-dot" style="background:linear-gradient(135deg,#091a10,#34d468)">ğŸŒ™</div><div class="swatch-name">Green Dark</div></div>
    </div>
  </div>

  <!-- Font -->
  <div class="pp-section">
    <div class="pp-label">Font</div>
    <div class="font-list" id="pp-font-list">
      <div class="font-opt active" data-font="jakarta" onclick="setFont('jakarta',this)"><span class="font-preview" style="font-family:'Plus Jakarta Sans',sans-serif">Plus Jakarta Sans</span><svg class="font-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg></div>
      <div class="font-opt" data-font="dm" onclick="setFont('dm',this)"><span class="font-preview" style="font-family:'DM Sans',sans-serif">DM Sans</span><svg class="font-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg></div>
      <div class="font-opt" data-font="nunito" onclick="setFont('nunito',this)"><span class="font-preview" style="font-family:'Nunito',sans-serif">Nunito â€” Rounded</span><svg class="font-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg></div>
      <div class="font-opt" data-font="fraunces" onclick="setFont('fraunces',this)"><span class="font-preview" style="font-family:'Fraunces',serif">Fraunces â€” Serif</span><svg class="font-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg></div>
      <div class="font-opt" data-font="mono" onclick="setFont('mono',this)"><span class="font-preview" style="font-family:'IBM Plex Mono',monospace">IBM Plex Mono</span><svg class="font-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg></div>
    </div>
  </div>

  <!-- Sign out -->
  <div class="pp-section">
    <button class="pp-logout-btn" onclick="signOut()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Sign Out
    </button>
  </div>

  <div style="height:env(safe-area-inset-bottom,0px)"></div>
</div>

<!-- â•â• WALLPAPER PICKER PANEL â•â• -->
<div id="wp-back" onclick="closeWallpaperPicker()"></div>
<div id="wp-panel">
  <div class="wp-pill"></div>
  <div class="wp-title">ğŸ–¼ï¸ Page Wallpaper</div>
  <div class="wp-subtitle" id="wp-panel-subtitle">Set background for current page</div>

  <div class="wp-section">
    <div class="wp-none" id="wp-none-opt" onclick="setWallpaper(null)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      No wallpaper
    </div>

    <div class="wp-section-label">Gradients</div>
    <div class="wp-grid" id="wp-gradient-grid">
      <!-- filled by JS -->
    </div>

    <div class="wp-section-label" style="margin-top:12px">Patterns</div>
    <div class="wp-grid" id="wp-pattern-grid"></div>

    <div class="wp-section-label" style="margin-top:12px">Custom Image URL</div>
    <div class="wp-url-row">
      <input class="wp-url-inp" id="wp-url-input" type="url" placeholder="https://example.com/photo.jpg">
      <button class="btn sm pri" onclick="applyCustomWallpaper()">Apply</button>
    </div>
  </div>
  <div style="height:calc(16px + env(safe-area-inset-bottom,0px))"></div>
</div>

<!-- PAGE MODAL -->
<div class="modal-back" id="pg-modal" onclick="if(event.target===this)closeM('pg-modal')">
  <div class="modal">
    <div class="modal-pill"></div>
    <div class="modal-title" id="pg-mtitle">New Page</div>
    <div class="ff"><label class="fl">Name</label><input class="fi" id="pg-name" type="text" placeholder="Research, Project, Ideasâ€¦" autocomplete="off"></div>
    <div style="display:flex;gap:10px">
      <div class="ff" style="width:86px"><label class="fl">Icon</label><input class="fi" id="pg-icon" type="text" placeholder="ğŸ“„" maxlength="2"></div>
      <div class="ff" style="flex:1"><label class="fl">Parent page</label><select class="fsl" id="pg-par"></select></div>
    </div>
    <div class="mac">
      <button class="btn gh" onclick="closeM('pg-modal')">Cancel</button>
      <button class="btn pri" onclick="savePg()">Create Page</button>
    </div>
  </div>
</div>

<!-- NOTE MODAL -->
<div class="modal-back" id="nt-modal" onclick="if(event.target===this)closeM('nt-modal')">
  <div class="modal">
    <div class="modal-pill"></div>
    <div class="modal-title" id="nt-heading">Add HTML Note</div>
    <div class="ff"><label class="fl">Title</label><input class="fi" id="nt-title" type="text" placeholder="Untitled" autocomplete="off"></div>
    <div class="ff"><label class="fl">HTML Content</label><textarea class="fta" id="nt-html" placeholder="<h1>Hello</h1>&#10;<p>Paste your HTML hereâ€¦</p>" rows="5"></textarea></div>
    <div class="ff">
      <label class="fl">Card Size <em style="font-weight:400;text-transform:none;font-size:10px;opacity:.6">(desktop)</em></label>
      <select class="fsl" id="nt-sz">
        <option value="sz-s">Small</option><option value="sz-m" selected>Medium</option>
        <option value="sz-l">Large</option><option value="sz-xl">XL</option><option value="sz-fw">Full Width</option>
      </select>
    </div>
    <div class="mac">
      <button class="btn gh" onclick="closeM('nt-modal')">Cancel</button>
      <button class="btn pri" onclick="saveNote()">Save Note</button>
    </div>
  </div>
</div>

<!-- Hidden inputs -->
<input type="file" id="file-inp" multiple accept=".html,.htm" style="display:none">
<input type="file" id="avatar-inp" accept="image/*" style="display:none">

<div id="dropzone"><div class="dz-lbl">Drop HTML files here</div></div>
<div id="toast"></div>

<!-- FIREBASE - ADDED NON-INVASIVELY AT THE END -->
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries
  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyApfhVfMwkcOH4wMTdLo7fMToitdtd8g2U",
    authDomain: "zchat-pro.firebaseapp.com",
    databaseURL: "https://zchat-pro-default-rtdb.firebaseio.com",
    projectId: "zchat-pro",
    storageBucket: "zchat-pro.firebasestorage.app",
    messagingSenderId: "680122982571",
    appId: "1:680122982571:web:e21f78f716073d029957ee"
  };
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  console.log("Firebase initialized (non-invasive)");
</script>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE (COMPLETELY UNCHANGED - ORIGINAL)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let pages=[], curId=null, curV='grid', dkOpen=true, _pgCb=null, _ntEdit=null;
let currentUser = null; // { name, email, avatarUrl, bio, isDemo }
const SK='hn_v8', PK='hn_prefs_v2', UK='hn_user_v1';

const $=id=>document.getElementById(id);
const esc=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const uid=()=>Math.random().toString(36).slice(2,10);
const isMob=()=>window.innerWidth<=640;
const findPg=id=>pages.find(p=>p.id===id);
const kidsOf=pid=>pages.filter(p=>p.parentId===(pid??null));
function ancestors(id){const a=[];let p=findPg(id);while(p){a.unshift(p);p=p.parentId?findPg(p.parentId):null;}return a;}
function descs(id){const r=[];(function w(i){kidsOf(i).forEach(c=>{r.push(c.id);w(c.id);});})(id);return r;}

function save(){try{localStorage.setItem(SK,JSON.stringify({pages}));}catch(e){}}
function load(){try{const d=JSON.parse(localStorage.getItem(SK)||'{}');pages=d.pages||[];}catch(e){pages=[];}}

/* â”€â”€ PREFS â”€â”€ */
let prefs={theme:'blue-light',font:'jakarta'};
function loadPrefs(){try{const p=JSON.parse(localStorage.getItem(PK)||'{}');prefs={...prefs,...p};}catch(e){}}
function savePrefs(){try{localStorage.setItem(PK,JSON.stringify(prefs));}catch(e){}}
function applyPrefs(){
  document.body.dataset.theme=prefs.theme;
  document.body.dataset.font=prefs.font;
  document.querySelectorAll('.theme-swatch').forEach(s=>s.classList.toggle('active',s.dataset.theme===prefs.theme));
  document.querySelectorAll('.font-opt').forEach(o=>o.classList.toggle('active',o.dataset.font===prefs.font));
}
function setTheme(t,el){prefs.theme=t;savePrefs();applyPrefs();}
function setFont(f,el){prefs.font=f;savePrefs();applyPrefs();}

/* â”€â”€ USER â”€â”€ */
function loadUser(){try{const u=JSON.parse(localStorage.getItem(UK)||'null');if(u)currentUser=u;}catch(e){}}
function saveUser(){try{localStorage.setItem(UK,JSON.stringify(currentUser));}catch(e){}}

function getInitials(name){
  if(!name)return '?';
  return name.trim().split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
}

function renderAvatarAll(){
  const u=currentUser;
  if(!u)return;
  // topbar avatar
  const ta=$('topbar-avatar');
  if(ta){ ta.innerHTML = u.avatarUrl?`<img src="${u.avatarUrl}" alt="avatar">`:`<span>${getInitials(u.name)}</span>`; }
  // mobile bar avatar
  const ba=$('bb-profile-avatar');
  if(ba){ ba.innerHTML = u.avatarUrl?`<img src="${u.avatarUrl}" alt="avatar">`:`<span style="font-size:11px;font-weight:700;color:var(--accent)">${getInitials(u.name)}</span>`; }
  // profile panel avatar
  const pa=$('pp-avatar-display');
  if(pa){ pa.innerHTML = u.avatarUrl?`<img src="${u.avatarUrl}" alt="avatar">`:`<span>${getInitials(u.name)}</span>`; }
  // profile panel info
  $('pp-display-name').textContent=u.name||'Guest';
  $('pp-display-email').textContent=u.email||'';
  $('pp-display-badge').innerHTML=u.isDemo
    ?`<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg> Demo Mode`
    :`<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Signed In`;
  // profile inputs
  $('pp-name-input').value=u.name||'';
  $('pp-bio-input').value=u.bio||'';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let authMode='login';

function switchAuthTab(mode, el){
  authMode=mode;
  document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('on'));
  el.classList.add('on');
  $('auth-login-fields').style.display=mode==='login'?'flex':'none';
  $('auth-signup-fields').style.display=mode==='signup'?'flex':'none';
  $('auth-submit-btn').textContent=mode==='login'?'Sign In':'Create Account';
  $('auth-error').textContent='';
}

function authSubmit(){
  $('auth-error').textContent='';
  if(authMode==='login'){
    const email=$('login-email').value.trim();
    const pass=$('login-pass').value;
    if(!email||!pass){$('auth-error').textContent='Please fill in all fields.';return;}
    // ğŸ”¥ Firebase auth will go here
    // For now: simulate success
    loginUser({name:email.split('@')[0],email,isDemo:false});
  } else {
    const name=$('signup-name').value.trim();
    const email=$('signup-email').value.trim();
    const pass=$('signup-pass').value;
    if(!name||!email||!pass){$('auth-error').textContent='Please fill in all fields.';return;}
    if(pass.length<6){$('auth-error').textContent='Password must be at least 6 characters.';return;}
    // ğŸ”¥ Firebase auth will go here
    loginUser({name,email,isDemo:false});
  }
}

function demoBypass(){
  loginUser({name:'Demo User',email:'demo@notez.app',isDemo:true,avatarUrl:null,bio:''});
}

function loginUser(user){
  currentUser={...user};
  saveUser();
  $('auth-screen').classList.add('hide');
  setTimeout(()=>{$('auth-screen').style.display='none';},320);
  $('app').classList.add('visible');
  renderAvatarAll();
  toast('Welcome, '+user.name+' âœ¨');
}

function signOut(){
  if(!confirm('Sign out of NoteZ?'))return;
  currentUser=null;
  localStorage.removeItem(UK);
  closeProfile();
  $('app').classList.remove('visible');
  $('auth-screen').style.display='flex';
  setTimeout(()=>$('auth-screen').classList.remove('hide'),20);
  // Reset auth form
  $('login-email').value='';$('login-pass').value='';
  $('auth-error').textContent='';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILE PANEL (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openProfile(){
  renderAvatarAll();
  $('profile-panel').classList.add('on');
  $('profile-back').classList.add('on');
}
function closeProfile(){
  $('profile-panel').classList.remove('on');
  $('profile-back').classList.remove('on');
}

function saveProfile(){
  if(!currentUser)return;
  currentUser.name=$('pp-name-input').value.trim()||currentUser.name;
  currentUser.bio=$('pp-bio-input').value.trim();
  saveUser();
  renderAvatarAll();
  closeProfile();
  toast('Profile saved âœ“');
}

function triggerAvatarUpload(){$('avatar-inp').click();}
function onAvatarFile(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    currentUser.avatarUrl=ev.target.result;
    saveUser();renderAvatarAll();toast('Avatar updated âœ“');
  };
  reader.readAsDataURL(file);
  e.target.value='';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WALLPAPER SYSTEM (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GRADIENTS=[
  {id:'g1',css:'linear-gradient(135deg,#667eea,#764ba2)',label:'Purple Dream'},
  {id:'g2',css:'linear-gradient(135deg,#f093fb,#f5576c)',label:'Pink Flamingo'},
  {id:'g3',css:'linear-gradient(135deg,#4facfe,#00f2fe)',label:'Ocean Breeze'},
  {id:'g4',css:'linear-gradient(135deg,#43e97b,#38f9d7)',label:'Mint Fresh'},
  {id:'g5',css:'linear-gradient(135deg,#fa709a,#fee140)',label:'Sunset Glow'},
  {id:'g6',css:'linear-gradient(135deg,#30cfd0,#330867)',label:'Deep Space'},
  {id:'g7',css:'linear-gradient(135deg,#a18cd1,#fbc2eb)',label:'Lavender'},
  {id:'g8',css:'linear-gradient(135deg,#ffecd2,#fcb69f)',label:'Peach Fuzz'},
  {id:'g9',css:'linear-gradient(135deg,#2d3561,#c05c7e)',label:'Midnight'},
  {id:'g10',css:'linear-gradient(135deg,#f7971e,#ffd200)',label:'Golden Hour'},
  {id:'g11',css:'linear-gradient(135deg,#396afc,#2948ff)',label:'Electric Blue'},
  {id:'g12',css:'linear-gradient(135deg,#11998e,#38ef7d)',label:'Emerald'},
];

const PATTERNS=[
  {id:'p1',css:"url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\")",label:'Plus Pattern',preview:'#e8e8f0'},
  {id:'p2',css:"url(\"data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23aaaacc' fill-opacity='0.2'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E\")",label:'Diagonal',preview:'#f0f0f8'},
  {id:'p3',css:"url(\"data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23aaaacc' fill-opacity='0.15'%3E%3Ccircle cx='3' cy='3' r='1.5'/%3E%3C/g%3E%3C/svg%3E\")",label:'Dots',preview:'#f5f5ff'},
  {id:'p4',css:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Cpath fill='%23aaaacc' fill-opacity='0.1' d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z'/%3E%3C/g%3E%3C/svg%3E\")",label:'Bubbles',preview:'#f0f4ff'},
];

function buildWallpaperSwatches(){
  const gg=$('wp-gradient-grid');
  gg.innerHTML='';
  GRADIENTS.forEach(g=>{
    const d=document.createElement('div');
    d.className='wp-swatch';d.dataset.id=g.id;
    d.style.background=g.css;
    d.innerHTML='<div class="wp-check">âœ“</div>';
    d.onclick=()=>setWallpaper(g.id,'gradient',g.css);
    gg.appendChild(d);
  });
  const pg=$('wp-pattern-grid');
  pg.innerHTML='';
  PATTERNS.forEach(p=>{
    const d=document.createElement('div');
    d.className='wp-swatch';d.dataset.id=p.id;
    d.style.background=p.preview+' '+p.css;
    d.innerHTML='<div class="wp-check">âœ“</div>';
    d.onclick=()=>setWallpaper(p.id,'pattern',p.css+' center/auto');
    pg.appendChild(d);
  });
}

function openWallpaperPicker(){
  if(!curId){toast('Select a page first');return;}
  const pg=findPg(curId);
  $('wp-panel-subtitle').textContent='Wallpaper for: '+(pg?.icon||'')+'  '+(pg?.name||'');
  // mark current
  const cur=pg?.wallpaper||null;
  document.querySelectorAll('.wp-swatch').forEach(s=>s.classList.toggle('active',cur&&s.dataset.id===cur.id));
  $('wp-none-opt').classList.toggle('active',!cur);
  $('wp-url-input').value='';
  $('wp-panel').classList.add('on');
  $('wp-back').classList.add('on');
}
function closeWallpaperPicker(){
  $('wp-panel').classList.remove('on');
  $('wp-back').classList.remove('on');
}

function setWallpaper(id,type,css){
  const pg=findPg(curId);if(!pg)return;
  if(id===null){
    pg.wallpaper=null;
  } else {
    pg.wallpaper={id,type,css};
  }
  save();applyWallpaper();
  document.querySelectorAll('.wp-swatch').forEach(s=>s.classList.toggle('active',id&&s.dataset.id===id));
  $('wp-none-opt').classList.toggle('active',!id);
  closeWallpaperPicker();
  toast(id?'Wallpaper set âœ¨':'Wallpaper removed');
}

function applyCustomWallpaper(){
  const url=$('wp-url-input').value.trim();
  if(!url){toast('Please enter a URL');return;}
  setWallpaper('custom','url','url('+url+') center/cover no-repeat');
}

function applyWallpaper(){
  const pg=findPg(curId);
  const content=$('content');
  if(pg?.wallpaper){
    content.style.background=pg.wallpaper.css;
  } else {
    content.style.background='';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toast(msg,ms=2000){const t=$('toast');t.textContent=msg;t.classList.add('on');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('on'),ms);}
function openM(id){$(id).classList.add('on');}
function closeM(id){$(id).classList.remove('on');}

function openSB(){$('sidebar').classList.add('on');$('sb-back').classList.add('on');}
function closeSB(){$('sidebar').classList.remove('on');$('sb-back').classList.remove('on');}
function dkToggle(){dkOpen=!dkOpen;$('sidebar').classList.toggle('dk-col',!dkOpen);}
function autoClose(){if(isMob())closeSB();}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE TREE (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTree(){const c=$('tree');c.innerHTML='';buildKids(null,0,c);}
function buildKids(pid,d,el){kidsOf(pid).forEach(p=>el.appendChild(makeNode(p,d)));}
function makeNode(p,depth){
  const wrap=document.createElement('div');wrap.className='tnode';
  const hasK=kidsOf(p.id).length>0;
  const row=document.createElement('div');
  row.className='trow'+(p.id===curId?' on':'');
  row.style.paddingLeft=(depth*16+10)+'px';

  const tog=document.createElement('span');
  tog.className='rtog'+(hasK?(p.collapsed?'':' op'):' lf');
  tog.innerHTML='<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>';
  tog.onclick=e=>{e.stopPropagation();p.collapsed=!p.collapsed;save();renderTree();};

  const ico=document.createElement('span');ico.className='rico';ico.textContent=p.icon||'ğŸ“„';
  const nm=document.createElement('span');nm.className='rname';nm.textContent=p.name;

  // Wallpaper indicator dot
  if(p.wallpaper){
    const dot=document.createElement('span');
    dot.style.cssText='width:6px;height:6px;border-radius:50%;background:var(--accent);flex-shrink:0;opacity:.7;';
    nm.after(dot);
  }

  const acts=document.createElement('div');acts.className='ract';
  acts.appendChild(mkib('<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>','Sub-page',e=>{e.stopPropagation();openPgModal(p.id);}));
  acts.appendChild(mkib('<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>','Rename',e=>{e.stopPropagation();inlineRen(p,nm);}));
  acts.appendChild(mkib('<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M9 6V4h6v2"/></svg>','Delete',e=>{e.stopPropagation();delPg(p.id);},true));

  row.append(tog,ico,nm,acts);
  row.addEventListener('click',()=>{selPg(p.id);autoClose();});
  row.draggable=true;
  row.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',p.id);row.style.opacity='.35';});
  row.addEventListener('dragend',()=>row.style.opacity='');
  row.addEventListener('dragover',e=>{e.preventDefault();row.classList.add('dov');});
  row.addEventListener('dragleave',()=>row.classList.remove('dov'));
  row.addEventListener('drop',e=>{
    e.preventDefault();row.classList.remove('dov');
    const sid=e.dataTransfer.getData('text/plain');
    if(sid===p.id||descs(sid).includes(p.id))return;
    const src=findPg(sid);pages=pages.filter(x=>x.id!==sid);
    const idx=pages.findIndex(x=>x.id===p.id);src.parentId=p.parentId;
    pages.splice(idx,0,src);save();renderTree();
  });

  wrap.appendChild(row);
  if(hasK){const cw=document.createElement('div');cw.className='tchildren';cw.style.display=p.collapsed?'none':'';buildKids(p.id,depth+1,cw);wrap.appendChild(cw);}
  return wrap;
}
function mkib(svg,title,fn,isDel=false){
  const b=document.createElement('button');b.className='ib'+(isDel?' danger':'');b.title=title;b.innerHTML=svg;
  b.addEventListener('click',fn);return b;
}
function inlineRen(p,nm){
  const inp=document.createElement('input');inp.className='rname-inp';inp.value=p.name;
  nm.replaceWith(inp);inp.focus();inp.select();
  const done=()=>{if(inp.value.trim())p.name=inp.value.trim();save();renderTree();if(p.id===curId)renderBC();};
  inp.addEventListener('blur',done);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')inp.blur();if(e.key==='Escape'){inp.value=p.name;inp.blur();}});
}

/* â”€â”€ PAGE CRUD (COMPLETELY UNCHANGED) â”€â”€ */
function openPgModal(parentId){
  $('pg-mtitle').textContent='New Page';$('pg-name').value='';$('pg-icon').value='';
  const sel=$('pg-par');sel.innerHTML='<option value="">â€” root â€”</option>';
  pages.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=(p.icon||'ğŸ“„')+' '+p.name;if(p.id===parentId)o.selected=true;sel.appendChild(o);});
  _pgCb=(name,icon,par)=>{
    const pg={id:uid(),name,icon:icon||'ğŸ“„',parentId:par||null,collapsed:false,notes:[],wallpaper:null};
    pages.push(pg);save();renderTree();selPg(pg.id);autoClose();toast('"'+name+'" created âœ¨');
  };
  openM('pg-modal');setTimeout(()=>$('pg-name').focus(),100);
}
function savePg(){const n=$('pg-name').value.trim();if(!n){$('pg-name').focus();return;}_pgCb&&_pgCb(n,$('pg-icon').value.trim(),$('pg-par').value);closeM('pg-modal');}
function delPg(id){
  const p=findPg(id);const dd=descs(id);
  if(!confirm('Delete "'+p.name+'"'+(dd.length?' + '+dd.length+' sub-pages':'')+' ?'))return;
  pages=pages.filter(x=>![id,...dd].includes(x.id));
  if([id,...dd].includes(curId)){curId=null;showEmpty();}
  save();renderTree();toast('Deleted');
}

/* â”€â”€ SELECT PAGE â”€â”€ */
function selPg(id){curId=id;renderTree();renderBC();applyWallpaper();setView(curV);}
function renderBC(){
  const bc=$('breadcrumb');bc.innerHTML='';if(!curId)return;
  ancestors(curId).forEach((p,i,a)=>{
    const s=document.createElement('span');s.className='bc-item'+(i===a.length-1?' bc-cur':'');
    s.textContent=(p.icon||'')+' '+p.name;
    if(i<a.length-1)s.addEventListener('click',()=>selPg(p.id));
    bc.appendChild(s);
    if(i<a.length-1){const sep=document.createElement('span');sep.className='bc-sep';sep.textContent='/';bc.appendChild(sep);}
  });
}

/* â”€â”€ VIEWS (COMPLETELY UNCHANGED) â”€â”€ */
function setView(v){
  curV=v;
  document.querySelectorAll('.vtab').forEach(t=>t.classList.toggle('on',t.dataset.v===v));
  $('bb-grid')&&$('bb-grid').classList.toggle('on',v==='grid');
  $('bb-focus')&&$('bb-focus').classList.toggle('on',v==='focus');
  ['empty-view','grid-view','focus-view'].forEach(id=>$(id).classList.remove('on'));
  if(!curId){showEmpty();return;}
  if(v==='grid'){$('grid-view').classList.add('on');renderGrid();}
  else{$('focus-view').classList.add('on');renderFocus();}
}
function showEmpty(){curId=null;renderBC();$('empty-view').classList.add('on');$('content').style.background='';}

/* â”€â”€ GRID (COMPLETELY UNCHANGED) â”€â”€ */
function renderGrid(){
  const pg=findPg(curId);const c=$('cards-wrap');c.innerHTML='';if(!pg)return;
  if(!pg.notes.length){
    const t=document.createElement('div');
    t.style.cssText='width:100%;padding:48px 0;text-align:center;color:var(--text3);font-size:14px;';
    t.innerHTML='<div style="font-size:40px;margin-bottom:12px">ğŸ—’ï¸</div>No notes yet â€” tap + to add one';
    c.appendChild(t);return;
  }
  pg.notes.forEach(n=>c.appendChild(makeCard(n,pg)));
}
function makeCard(n,pg){
  const card=document.createElement('div');
  card.className='ncard '+(n.sz||'sz-m');
  if(n.cw)card.style.width=n.cw;if(n.ch)card.style.height=n.ch;

  const hdr=document.createElement('div');hdr.className='card-hdr';
  const bar=document.createElement('div');bar.className='card-accent-bar';
  const nm=Object.assign(document.createElement('span'),{className:'card-name',textContent:n.title});
  const badge=Object.assign(document.createElement('span'),{className:'card-badge',textContent:'HTML'});
  const tools=document.createElement('div');tools.className='card-tools';

  const ss=document.createElement('select');
  [['sz-s','S'],['sz-m','M'],['sz-l','L'],['sz-xl','XL'],['sz-fw','Full']].forEach(([v,l])=>{
    const o=document.createElement('option');o.value=v;o.textContent=l;if(v===(n.sz||'sz-m'))o.selected=true;ss.appendChild(o);
  });
  ss.addEventListener('change',()=>{n.sz=ss.value;n.cw=n.ch=null;card.className='ncard '+n.sz;card.style.width=card.style.height='';save();});
  const eb=mkib('<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>','Edit',()=>editNote(n));
  const db=mkib('<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg>','Remove',()=>{pg.notes=pg.notes.filter(x=>x.id!==n.id);save();renderGrid();},true);
  tools.append(ss,eb,db);hdr.append(bar,nm,badge,tools);

  const body=document.createElement('div');body.className='card-body';
  const fr=document.createElement('iframe');fr.className='card-iframe';fr.sandbox='allow-scripts allow-same-origin allow-forms allow-popups allow-presentation allow-top-navigation';fr.srcdoc=n.html;body.appendChild(fr);
  const rk=document.createElement('div');rk.className='resize-k';
  rk.innerHTML='<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="16 20 20 20 20 16"/><line x1="14" y1="14" x2="20" y2="20"/></svg>';
  rk.addEventListener('mousedown',e=>startResize(e,card,n));
  card.append(hdr,body,rk);

  hdr.draggable=true;
  hdr.addEventListener('dragstart',e=>{card.classList.add('drag-src');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('nt-id',n.id);});
  hdr.addEventListener('dragend',()=>card.classList.remove('drag-src'));
  card.addEventListener('dragover',e=>{e.preventDefault();card.style.outline='2px solid var(--accent)';});
  card.addEventListener('dragleave',()=>card.style.outline='');
  card.addEventListener('drop',e=>{
    e.preventDefault();card.style.outline='';
    const sid=e.dataTransfer.getData('nt-id');if(!sid||sid===n.id)return;
    const p2=findPg(curId);const fi=p2.notes.findIndex(x=>x.id===sid);const ti=p2.notes.findIndex(x=>x.id===n.id);
    if(fi<0||ti<0)return;
    const m=card.getBoundingClientRect().left+card.offsetWidth/2;
    const ins=e.clientX<m?ti:ti+1;const[mv]=p2.notes.splice(fi,1);
    p2.notes.splice(ins>fi?ins-1:ins,0,mv);save();renderGrid();
  });
  return card;
}
function startResize(e,card,n){
  e.preventDefault();const sx=e.clientX,sy=e.clientY,sw=card.offsetWidth,sh=card.offsetHeight;
  const mm=ev=>{card.style.width=Math.max(200,sw+ev.clientX-sx)+'px';card.style.height=Math.max(120,sh+ev.clientY-sy)+'px';card.className='ncard';};
  const mu=()=>{n.sz='';n.cw=card.style.width;n.ch=card.style.height;save();document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);};
  document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu);
}

/* â”€â”€ FOCUS (COMPLETELY UNCHANGED) â”€â”€ */
function renderFocus(){
  const pg=findPg(curId);if(!pg)return;
  $('focus-frame').srcdoc='<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{box-sizing:border-box}body{margin:0;font-family:sans-serif}.n{border-bottom:1px solid #f0f0f0;padding:24px 20px}.n:last-child{border-bottom:none}.nl{font-size:10px;font-weight:700;color:#aaa;text-transform:uppercase;letter-spacing:.08em;margin-bottom:12px;font-family:monospace}</style></head><body>'
  +pg.notes.map(n=>'<div class="n"><div class="nl">ğŸ“ '+esc(n.title)+'</div>'+n.html+'</div>').join('')
  +(!pg.notes.length?'<p style="padding:48px;color:#aaa;text-align:center">No notes yet</p>':'')+'</body></html>';
}

/* â”€â”€ NOTE MODAL (COMPLETELY UNCHANGED) â”€â”€ */
function openNoteModal(){
  if(!curId){toast('Pick a page first');if(isMob())openSB();return;}
  _ntEdit=null;$('nt-heading').textContent='Add HTML Note';
  $('nt-title').value='';$('nt-html').value='';$('nt-sz').value='sz-m';
  openM('nt-modal');setTimeout(()=>$('nt-title').focus(),100);
}
function editNote(n){
  _ntEdit=n.id;$('nt-heading').textContent='Edit Note';
  $('nt-title').value=n.title;$('nt-html').value=n.html;$('nt-sz').value=n.sz||'sz-m';
  openM('nt-modal');
}
function saveNote(){
  const title=$('nt-title').value.trim()||'Untitled';const html=$('nt-html').value;const sz=$('nt-sz').value;
  const pg=findPg(curId);if(!pg)return;
  if(_ntEdit){const n=pg.notes.find(x=>x.id===_ntEdit);if(n){n.title=title;n.html=html;n.sz=sz;n.cw=n.ch=null;}}
  else pg.notes.push({id:uid(),title,html,sz});
  save();closeM('nt-modal');
  if(curV==='grid')renderGrid();else renderFocus();
  toast(_ntEdit?'Updated âœï¸':'Note added âœ¨');
}

/* â”€â”€ FILES (COMPLETELY UNCHANGED) â”€â”€ */
function pickFiles(){$('file-inp').click();}

// Fix: Add event listener for file input
document.getElementById('file-inp').addEventListener('change', function(e) {
  ingest([...e.target.files]);
  e.target.value = '';
});

document.getElementById('avatar-inp').addEventListener('change', function(e) {
  onAvatarFile(e);
});

function onFiles(e){ingest([...e.target.files]);e.target.value='';}
function ingest(files){
  const hl=files.filter(f=>/\.html?$/i.test(f.name));
  if(!hl.length){toast('No HTML files found');return;}
  if(!curId){
    const pg={id:uid(),name:hl.length===1?hl[0].name.replace(/\.html?$/i,''):'Uploaded',icon:'ğŸ“‚',parentId:null,collapsed:false,notes:[],wallpaper:null};
    pages.push(pg);save();renderTree();selPg(pg.id);setTimeout(()=>loadFiles(hl,pg.id),60);
  }else loadFiles(hl,curId);
}
function loadFiles(files,pgId){
  const pg=findPg(pgId);if(!pg)return;let n=0;
  files.forEach(f=>{const r=new FileReader();r.onload=e=>{
    pg.notes.push({id:uid(),title:f.name.replace(/\.html?$/i,''),html:e.target.result,sz:'sz-l'});
    if(++n===files.length){save();if(curId===pgId){if(curV==='grid')renderGrid();else renderFocus();}toast(n+' file(s) added ğŸ“„');}
  };r.readAsText(f);});
}

/* â”€â”€ GLOBAL DROP (COMPLETELY UNCHANGED) â”€â”€ */
let _dt;
window.addEventListener('dragenter',e=>{if([...e.dataTransfer.types].includes('Files')){$('dropzone').classList.add('on');clearTimeout(_dt);}});
window.addEventListener('dragleave',e=>{if(!e.relatedTarget||e.relatedTarget===document.documentElement)_dt=setTimeout(()=>$('dropzone').classList.remove('on'),80);});
window.addEventListener('dragover',e=>e.preventDefault());
window.addEventListener('drop',e=>{e.preventDefault();$('dropzone').classList.remove('on');ingest([...e.dataTransfer.files]);});

/* â”€â”€ KEYBOARD (COMPLETELY UNCHANGED) â”€â”€ */
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){document.querySelectorAll('.modal-back.on').forEach(m=>m.classList.remove('on'));closeProfile();closeWallpaperPicker();}
  if((e.ctrlKey||e.metaKey)&&e.key==='n'){e.preventDefault();openPgModal(curId||null);}
  if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){e.preventDefault();openNoteModal();}
  if((e.ctrlKey||e.metaKey)&&e.key==='\\'){e.preventDefault();dkToggle();}
  if((e.ctrlKey||e.metaKey)&&e.key===','){e.preventDefault();openProfile();}
});
$('pg-name').addEventListener('keydown',e=>{if(e.key==='Enter')savePg();});
$('nt-title').addEventListener('keydown',e=>{if(e.key==='Enter')$('nt-html').focus();});

// Auth enter key
['login-pass','signup-pass'].forEach(id=>$(id).addEventListener('keydown',e=>{if(e.key==='Enter')authSubmit();}));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT (COMPLETELY UNCHANGED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
load();loadPrefs();loadUser();applyPrefs();buildWallpaperSwatches();renderTree();

// Check if already logged in
if(currentUser){
  $('auth-screen').style.display='none';
  $('app').classList.add('visible');
  renderAvatarAll();
  showEmpty();
  if(pages.length===0) bootWelcome();
} else {
  showEmpty();
  if(pages.length===0) bootWelcome();
}

function bootWelcome(){
  const w={id:uid(),name:'Getting Started',icon:'âœ¨',parentId:null,collapsed:false,notes:[{
    id:uid(),title:'Welcome to NoteZ',sz:'sz-l',wallpaper:null,
    html:`<style>body{font-family:system-ui,sans-serif;padding:20px 18px;line-height:1.7;background:#fff;color:#1a1a2e;margin:0}h1{font-size:20px;font-weight:700;margin:0 0 6px;color:#1a1a2e}.sub{color:#888;font-size:13px;margin:0 0 18px}ul{margin:0 0 14px;padding-left:18px}li{margin-bottom:6px;font-size:13.5px}.tip{background:#f0f4ff;border-left:3px solid #2563eb;padding:10px 14px;border-radius:6px;font-size:12.5px;color:#2563eb;margin-top:14px}</style>
<h1>âœ¨ Welcome to NoteZ</h1><p class="sub">Your HTML-native workspace.</p>
<ul>
<li>ğŸ“± <strong>Mobile:</strong> icon bar at the bottom to navigate</li>
<li>ğŸ‘¤ Tap your <strong>avatar</strong> (bottom-right) for profile & settings</li>
<li>ğŸ–¼ï¸ Tap the <strong>image icon</strong> to set a page wallpaper</li>
<li>â˜° Tap <strong>menu</strong> to manage pages (full-screen sidebar)</li>
<li>â• Tap <strong>+</strong> to add HTML notes to the current page</li>
<li>ğŸ–¥ï¸ <strong>Desktop:</strong> drag to reorder, corner-drag to resize cards</li>
</ul>
<div class="tip">ğŸ’¡ You have 6 themes + 5 fonts â€” tap your avatar to customize!</div>`
  }],wallpaper:null};
  pages.push(w);save();renderTree();
}
</script>
</body>
</html>
